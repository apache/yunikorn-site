<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-1.4.0 docs-doc-page docs-doc-id-design/historical_usage_tracking" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">Historical Usage Tracking | Apache YuniKorn</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://yunikorn.apache.org/img/logo/yunikorn-logo-main.png"><meta data-rh="true" name="twitter:image" content="https://yunikorn.apache.org/img/logo/yunikorn-logo-main.png"><meta data-rh="true" property="og:url" content="https://yunikorn.apache.org/docs/1.4.0/design/historical_usage_tracking"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="1.4.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-1.4.0"><meta data-rh="true" name="docsearch:version" content="1.4.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-1.4.0"><meta data-rh="true" property="og:title" content="Historical Usage Tracking | Apache YuniKorn"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/img/yunikorn.ico"><link data-rh="true" rel="canonical" href="https://yunikorn.apache.org/docs/1.4.0/design/historical_usage_tracking"><link data-rh="true" rel="alternate" href="https://yunikorn.apache.org/docs/1.4.0/design/historical_usage_tracking" hreflang="en"><link data-rh="true" rel="alternate" href="https://yunikorn.apache.org/docs/1.4.0/design/historical_usage_tracking" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Q1V951BG2V-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Apache YuniKorn" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.57f4caef.css">
<script src="/assets/js/runtime~main.dd672f16.js" defer="defer"></script>
<script src="/assets/js/main.1ba8fec7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fIH8" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar__FTF" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_wDNR"></div><div class="content_DgxC announcementBarContent_HmXy">1.5.1 has been released, check the <a href="/community/download">DOWNLOADS</a>.</div><button type="button" aria-label="Close" class="clean-btn close closeButton_KmNL announcementBarClose_BG67"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo/yunikorn_blue_logo.png" alt="YuniKorn Site Logo" class="themedComponent_yzub themedComponent--light_pOwb"><img src="/img/logo/yunikorn_white_logo.png" alt="YuniKorn Site Logo" class="themedComponent_yzub themedComponent--dark_xdnF"></div><b class="navbar__title text--truncate">Apache YuniKorn</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/community/roadmap">Roadmap</a><a class="navbar__item navbar__link" href="/community/download">Download</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community/get_involved">Get Involved</a></li><li><a class="dropdown__link" href="/community/how_to_contribute">How to Contribute</a></li><li><a class="dropdown__link" href="/community/coding_guidelines">Coding Guidelines</a></li><li><a class="dropdown__link" href="/community/reporting_issues">Reporting Issues</a></li><li><a class="dropdown__link" href="/community/release_procedure">Release Procedure</a></li><li><a class="dropdown__link" href="/community/events">Events</a></li><li><a class="dropdown__link" href="/community/people">People</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Apache</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Apache Software Foundation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsors<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy Policy<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/1.4.0/">1.4.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/design/historical_usage_tracking">Next</a></li><li><a class="dropdown__link" href="/docs/design/historical_usage_tracking">1.5.1</a></li><li><a class="dropdown__link" href="/docs/1.5.0/design/historical_usage_tracking">1.5.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/1.4.0/design/historical_usage_tracking">1.4.0</a></li><li><a class="dropdown__link" href="/docs/1.3.0/">1.3.0</a></li><li><a class="dropdown__link" href="/docs/1.2.0/">1.2.0</a></li><li><a class="dropdown__link" href="/docs/1.1.0/">1.1.0</a></li><li><a class="dropdown__link" href="/docs/1.0.0/">1.0.0</a></li><li><a class="dropdown__link" href="/docs/0.12.2/">0.12.2</a></li><li><a class="dropdown__link" href="/docs/0.12.1/">0.12.1</a></li><li><a class="dropdown__link" href="/docs/0.11.0/">0.11.0</a></li><li><a class="dropdown__link" href="/docs/0.10.0/">0.10.0</a></li><li><a class="dropdown__link" href="/docs/0.9.0/">0.9.0</a></li><li><a class="dropdown__link" href="/docs/0.8.0/">0.8.0</a></li></ul></div><a href="https://github.com/apache/yunikorn-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_CXxL colorModeToggle_r3Ku"><button class="clean-btn toggleButton_A2Gq toggleButtonDisabled_MBgh" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_ZNXA"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon__KEK"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_eonw"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_txSM"><div class="docsWrapper_aujV"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_fDTy" type="button"></button><div class="docRoot_ITF8"><aside class="theme-doc-sidebar-container docSidebarContainer_coE9"><div class="sidebarViewport_XDus"><div class="sidebar_duME"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_d40_ menuWithAnnouncementBar_QXd6"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/1.4.0/">Get Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/1.4.0/user_guide/deployment_modes">User Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/1.4.0/developer_guide/env_setup">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/developer_guide/env_setup">Dev Environment Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/developer_guide/build">Build and Run</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/developer_guide/dependencies">Go module updates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/developer_guide/deployment">Deploy to Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/developer_guide/openshift_development">Development in CodeReady Containers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/1.4.0/design/architecture">Designs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/scheduler_plugin">K8s Scheduler Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/gang_scheduling">Gang scheduling design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/user_group">User/Group handling and lookup design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/user_based_resource_usage_tracking">User Based Resource Usage Tracking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/user_group_resource_usage_enforcement">User Based Quota Enforcement</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/1.4.0/design/historical_usage_tracking">Historical Usage Tracking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/interface_message_simplification">Simplifying Interface Messages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/cache_removal">Scheduler cache removal design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/preemption">Preemption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/simple_preemptor">DaemonSet Scheduling using Simple Preemptor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/generic_resource">Generic Resource Types in Namespace Quota</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/priority_scheduling">Priority Scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/resilience">Resilience</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/state_aware_scheduling">Batch Workloads Ordering with StateAware Policy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/scheduler_object_states">Scheduler Object States</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/config_v2">Configuration V2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.4.0/design/scheduler_configuration">Scheduler Configuration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/1.4.0/archived_design/k8shim">Archived Designs</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/1.4.0/performance/evaluate_perf_function_with_kubemark">Performance</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_fQ9A"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_L8rf"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Apache YuniKorn<!-- --> <b>1.4.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/design/historical_usage_tracking">latest version</a></b> (<!-- -->1.5.1<!-- -->).</div></div><div class="docItemContainer_J6oa"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer__4Nk" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_lw5W"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Designs</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Historical Usage Tracking</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 1.4.0</span><div class="tocCollapsible_hejs theme-doc-toc-mobile tocMobile_K3aG"><button type="button" class="clean-btn tocCollapsibleButton_a3TS">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Historical Usage Tracking</h1></header><h2 class="anchor anchorWithStickyNavbar_NlAN" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Tracking an application lifecycle is not easy in the current YuniKorn setup.
Logs and statedump data is required to build an overview.
Historical tracking of applications is only possible with limited detail per application.
Applications come and go, we only track what is running and a time limited set of completed applications.</p>
<p>Storing detailed tracking information in memory is problematic.
Unbound growth can cause performance issues or even an out of memory failure of the service.
The lessons learned from the YARN days have shown that it is not simple.</p>
<p>A conscious choice was also made to keep YuniKorn stateless.
The service does not maintain its own datastore for any of its operations.
Adding a datastore for application and usage tracking will complicate things.</p>
<p>Tracking data can be easily generated and made available for external consumption.
The design will discuss the option to generate an event stream for applications, queues and nodes to allow external tools to build an overview of the usage pattern.</p>
<p>Work to be tracked under <a href="https://issues.apache.org/jira/browse/YUNIKORN-1628" target="_blank" rel="noopener noreferrer">YUNIKORN-1628</a></p>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">​</a></h2>
<ul>
<li>Implementation of an event stream for an application, including:</li>
<li>State changes</li>
<li>Asks and allocation changes</li>
<li>Implementation of an event stream for a node, including:</li>
<li>State changes</li>
<li>Allocation changes</li>
<li>Implementation of an event stream for a queue, including:</li>
<li>State changes</li>
<li>Usage changes</li>
<li>Define a REST interface for event retrieval</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="non-goals">Non Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non Goals" title="Direct link to Non Goals">​</a></h2>
<ul>
<li>Add a data store for the historical data</li>
<li>Display the event information</li>
<li>Rebuild data on recovery</li>
<li>Historical data will not be rebuild</li>
<li>Authentication and Authorisation on the REST interface</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="existing-event-system">Existing Event System<a href="#existing-event-system" class="hash-link" aria-label="Direct link to Existing Event System" title="Direct link to Existing Event System">​</a></h2>
<p>The event system was designed to be far more flexible than the current usage.
Events for requests, applications, nodes and queues have been defined.
Most of those are currently not used.
The current event system is built on top of a generic event definition.
The scheduler interface defines the event as:</p>
<div class="language-go codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-go codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">si</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">EventRecord </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> recordType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ObjectID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  GroupID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Reason</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  TimestampNano</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">int64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Events definitions are used in the core and shim.
The simplicity of the events will most likely not match the current requirements.</p>
<p>As part of the standard scheduling cycle we track details at different levels.
Prometheus&#x27; metrics are tracked for specific changes and updates.
We also generate events, REQUEST events, that get passed back into the K8shim to attach to the Kubernetes pods.</p>
<p>The current events that get passed back are for:</p>
<ul>
<li><em>Insufficient Queue Resources</em>: part of the allocation cycle. Called from: <code>Application.tryAllocate()</code></li>
<li><em>Placeholder Size Mismatch</em>: part of the placeholder replacement cycle. Called from: <code>Application.tryPlaceholderAllocate()</code></li>
</ul>
<p>Both events are of the type REQUEST.
The K8shim also implements processing of NODE events but there is no code that generates those types of events.
The APPLICATION and QUEUE type events are not created or processed.</p>
<p>The event system was added as part of <a href="https://issues.apache.org/jira/browse/YUNIKORN-42" target="_blank" rel="noopener noreferrer">YUNIKORN-42</a>.
The jira contains a simple design document for the event system.
It only was implemented for events that we could not at that point get in any other way: <a href="https://docs.google.com/document/d/1aKfY6wnBPCyBl03UfmMHbTSpabAbfxtsHT2KzOgEOQs/edit" target="_blank" rel="noopener noreferrer">design v2</a>.
The original thought was a more generic event system.
It would relate everything back to either a pod or the YuniKorn CRD and was focussed on diagnostics and troubleshooting in general: <a href="https://docs.google.com/document/d/19iMkLJGVwTSq9OfV9p75wOobJXAxR_CRo4YzSRG_Pzw/edit#heading=h.worp3vfnqgtn" target="_blank" rel="noopener noreferrer">design v1</a>.
Linking it all back to a specific pod is The YuniKorn CRD is not used at this point in time.</p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="scheduler-integration">Scheduler integration<a href="#scheduler-integration" class="hash-link" aria-label="Direct link to Scheduler integration" title="Direct link to Scheduler integration">​</a></h3>
<p>When the event system was designed the whole purpose was to allow out of band processing of the events from the scheduling cycle.
The events are generated during the scheduling cycle and processed asynchronously in the event system.</p>
<p>A channel is used for collecting the events during the scheduling cycle.
The scheduler generates an event and adds it for processing to the channel.
After the placement of the event on the channel the scheduler proceeds with the normal cycle.
Processing of the events does not, and must not, block the scheduling cycle.</p>
<p>This part of the event system must be maintained as it will guarantee the performance of the scheduler.</p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="event-storage">Event storage<a href="#event-storage" class="hash-link" aria-label="Direct link to Event storage" title="Direct link to Event storage">​</a></h3>
<p>All events that have been sent to the channel are read from the channel and placed in a temporary store for publishing.
The store is a simple map with the key of the <em>ObjectID</em>.</p>
<p>Some of the assumptions in the event store however make it not directly usable for the purpose as described here.
The main limitation is that there can only be one event in the channel per <em>ObjectID</em>.
The newest one is kept, the older one is dropped when a new event comes in.
This however does not mean the code already available with minor changes could be re-used for this purpose.</p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="publishing-events">Publishing events<a href="#publishing-events" class="hash-link" aria-label="Direct link to Publishing events" title="Direct link to Publishing events">​</a></h3>
<p>The current event system uses a push system for event publishing.
The event system allows the creation of multiple event publishers.
There is no implementation or design for a pull system, like for instance a REST based interface.</p>
<p>Currently, there is only an event publisher for a shim defined.
This push system will send all the events that have been collected during the push interval to the shim.
All events that are pushed will be removed from the store.
This keeps the size of the store to a minimum.</p>
<p>There is no filtering or post-processing of events implemented.
Each event stored in the store is forwarded to the shim when the publisher runs.
See limitations of the store mentioned above.
In the earlier design a level filter was described.
That level was never part of the follow-up design, not in the events and not in the processing.</p>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="event-system-updates">Event System Updates<a href="#event-system-updates" class="hash-link" aria-label="Direct link to Event System Updates" title="Direct link to Event System Updates">​</a></h2>
<p>The currently defined events are not a fit for the system we want and need.
Since the events are only used between the core and the K8shim via the publisher we do not need to maintain backwards compatibility.
Changes can be made to the messages as we do not currently expose the message to the outside.</p>
<p>The <em>message</em> and <em>reason</em> fields are currently not properly used.
The content of the two overlaps.
The message in both cases contains the reason, in slightly different wording.
We do not need both.</p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="event-description">Event description<a href="#event-description" class="hash-link" aria-label="Direct link to Event description" title="Direct link to Event description">​</a></h3>
<p>We are also missing two fields to allow an extended usage for historical tracking: the <em>resource</em> and the <em>change type</em>.
Based on that the new message that would allow using the event system for tracking historical change would be:</p>
<div class="language-go codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-go codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">si</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">EventRecord </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventRecordType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ChangeType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventChangeType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ChangeDetail</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventChangeDetail</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  TimestampNano</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">int64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ObjectID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ReferenceID</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> si</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The existing <em>GroupID</em> has been renamed to <em>ReferenceID</em>. The
<em>ReferenceID</em> is the identification of the second object for the event.
As an example that would be the Allocation UUID for a new allocation
added to an application, request or node. For the queue that would be
the application ID.</p>
<p>Note that the order of the attributes in the final definition might be
different as we do not reuse names and IDs in the messages.</p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="event-types">Event types<a href="#event-types" class="hash-link" aria-label="Direct link to Event types" title="Direct link to Event types">​</a></h3>
<p>By keeping the event type for REQUESTS we can still fulfil the original
design of YUNIKORN-42. The current enumeration for the <em>eventRecordType</em>
would not change. Definition of the eventRecordType enumeration:</p>
<div class="language-text codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-text codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">UNKNOWN = 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">REQUEST = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP = 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE = 3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE = 4</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="change-types">Change types<a href="#change-types" class="hash-link" aria-label="Direct link to Change types" title="Direct link to Change types">​</a></h3>
<p>The additional change type that is added allows us to track the type of
change. Depending on the content of the other fields it provides the
possibility to track all changes we need to track. Definition of the
eventChangeType enumeration:</p>
<div class="language-text codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-text codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">NONE = 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SET = 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ADD = 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">REMOVE = 3</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="change-details">Change details<a href="#change-details" class="hash-link" aria-label="Direct link to Change details" title="Direct link to Change details">​</a></h3>
<p>Change detail provides more on the reason for the event. The change
detail is an enumerated value linked to the event types.</p>
<div class="language-text codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-text codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DETAILS_NONE = 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">REQUEST_CANCEL = 100 // Request cancelled by the RM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">REQUEST_ALLOC = 101 // Request allocated</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">REQUEST_TIMEOUT = 102 // Request cancelled due to timeout</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_ALLOC = 200 // Allocation changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_REQUEST = 201 // Request changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_REJECT = 202 // Application rejected on create</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_NEW = 203 // Application added with state new</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_ACCEPTED = 204 // State change to accepted</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_STARTING = 205 // State change to starting</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_RUNNING = 206 // State change to running</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_COMPLETING = 207 // State change to completing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_COMPLETED = 208 // State change to completed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_FAILING = 209 // State change to failing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_FAILED = 210 // State change to failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_RESUMING = 211; // State change to resuming</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">APP_EXPIRED = 212; // State change to expired</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE_DECOMISSION = 300 // Node removal</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE_READY = 301 // Node ready state change</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE_SCHEDULABLE = 302 // Node schedulable state change (cordon)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE_ALLOC = 303 // Allocation changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE_CAPACITY = 304 // Capacity changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE_OCCUPIED = 305 // Occupied resource changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NODE_RESERVATION = 306; // Reservation/unreservation occurred</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE_CONFIG = 400 // Managed queue update or removal</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE_DYNAMIC = 401 // Dynamic queue update or removal</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE_TYPE = 402 // Queue type change</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE_MAX = 403 // Max resource changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE_GUARANTEED = 404 // Guaranteed resource changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE_APP = 405 // Application changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">QUEUE_ALLOC = 406 // Allocation changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ALLOC_CANCEL = 500 // Allocation cancelled by the RM</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ALLOC_PREEMPT = 501 // Allocation preempted by the core</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ALLOC_TIMEOUT = 502 // Allocation cancelled due to timeout</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ALLOC_REPLACED = 503 // Allocation replacement (placeholder)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ALLOC_NODEREMOVED = 504 // Allocation cancelled, node removal</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="content-definition">Content definition<a href="#content-definition" class="hash-link" aria-label="Direct link to Content definition" title="Direct link to Content definition">​</a></h3>
<p>The <em>eventRecordType</em> defines the object that the <em>ObjectID</em> points to.
The content of the <em>ReferenceID</em> depends on two things:</p>
<ul>
<li>Change type</li>
<li>Object type inferred by the <em>eventRecordType</em></li>
</ul>
<p>For an object of type application it would not make sense to have the reference point to another application etc.
At this point the following mapping for <em>ReferenceID</em> is assumed:</p>
<table><thead><tr><th>Event Type</th><th>Reference ID</th></tr></thead><tbody><tr><td>REQUEST</td><td>ApplicationID</td></tr><tr><td>APP</td><td>Allocation UUID or Request UUID</td></tr><tr><td>NODE</td><td>Allocation UUID</td></tr><tr><td>QUEUE</td><td>ApplicationID or Allocation UUID</td></tr></tbody></table>
<p>If the <em>eventChangeType</em> Is NONE or SET the <em>ReferenceID</em> is always empty.
The exception is for the REQUEST as in that case the change type NONE has an application ID set.
This special case is used to implement the existing functionality of the event system: sending events to the shim.</p>
<p>The APP record type supports Request IDs and Allocation UUIDs to be set in the <em>ReferenceID</em>.
The type of ID that is referenced is defined by the <em>ChangeDetail</em>.</p>
<p>The QUEUE record type supports application IDs and Allocation UUIDs to be set in the <em>ReferenceID</em>.
Individual allocations are not tracked on the queue.
However, we leave that option open for the event system at this point.</p>
<p>For the QUEUE if <em>ReferenceID</em> and <em>Resource</em> are set, the ID points to an allocation.
This can only happen if the <em>ChangeDetail</em> is set to QUEUE_ALLOC.</p>
<p>If only the <em>ReferenceID</em> is set it points to an application.
This can only happen if the <em>ChangeDetail</em> is set to QUEUE_APP.
Both cases can use the same <em>eventChangeType</em>, add or remove an allocation or an application from a queue.</p>
<p>The <em>Resource</em> that is part of any event would be the size of the resource for that change.
The interpretation depends on the <em>eventChangeType</em>.
For a SET it is the absolute value. For the ADD and REMOVE it is the positive delta on the existing tracked value.
The <em>Resource</em> is always a positive value.</p>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="event-storage-1">Event storage<a href="#event-storage-1" class="hash-link" aria-label="Direct link to Event storage" title="Direct link to Event storage">​</a></h2>
<p>The storage of events needs to be updated to allow multiple events to be stored for an <em>ObjectID</em>.
This is required as one object could trigger multiple events in a short time and all are important to track.
This will require a change from a map based storage to a different store or a change in the key used for the map.</p>
<p>The simplest solution might be a slice of pointers to events.
The slice has a configurable, limited set of entries.
The slice is accessed and maintained as a ring buffer.
This will prevent an unlimited growth of the schedulers memory requirements.
During the implementation a decision will be made which configuration, time; count or both, for limiting the size will be supported.</p>
<p>Nil, or empty, events will not be added to the storage.
However, no publisher must assume that while processing events retrieved from the buffer and needs to handle nil references.
A location in the buffer could contain a nil pointer and must be skipped while iterating over the buffer.
If a publisher gets a nil event pointer it must not crash and proceed as normal.</p>
<p>The current design will use two stores: one for external retrieval and one for the shim events.
A filter at the receiving end will be created.
The shim events will then be processed as per the existing implementation.
The new events will be stored and managed as per this design document in <a href="#shim-events">SHIM events</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="publishing-events-1">Publishing events<a href="#publishing-events-1" class="hash-link" aria-label="Direct link to Publishing events" title="Direct link to Publishing events">​</a></h3>
<p>Events are currently not post processed and all events are sent to the shim.
With the newly added events the publishing needs to be split into two separate loops.</p>
<h4 class="anchor anchorWithStickyNavbar_NlAN" id="shim-events">SHIM events<a href="#shim-events" class="hash-link" aria-label="Direct link to SHIM events" title="Direct link to SHIM events">​</a></h4>
<p>Current functionality will be supported as described above.
Updates are required as the content of the events has changed.
The same event type will be generated.
The same processing mechanism will be used.</p>
<p>As part of processing events REQUEST type events are special.
The REQUEST type with the change type NONE has an application ID set and is only sent as an event to the shim.
These events must not be made available by any other publishers and are stored in a separate ring buffer.
After the event is sent to the shim the reference to the event in the buffer is cleared, replaced with a nil.</p>
<h4 class="anchor anchorWithStickyNavbar_NlAN" id="rest">REST<a href="#rest" class="hash-link" aria-label="Direct link to REST" title="Direct link to REST">​</a></h4>
<p>The REST service that is currently running can be reused for exposing the events.
Proposal is to add a new endpoint to the HTTP service.
The REST endpoint servicing the event data should be a new end point.</p>
<p>Based on the current REST api definition the data exposed in the following new endpoint will be added to expose the events:</p>
<div class="language-text codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-text codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/ws/v1/events/batch</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The design will not define a sophisticated interface for querying events, like filtering, grouping, etc.
This is a deliberate decision.
Such an API can encourage bad practices later on.
That should be done in a separate application which fetches the events from YuniKorn and persists them in a permanent storage and offers a more feature rich REST/query interface.
This would be similar to what already exists in Apache Hadoop like Job History Server or Application Timeline Service.</p>
<p>As mentioned earlier in this document, such an application is not in the scope.</p>
<p>The batch endpoint, by default, returns a limited number of events.
The number of events to return can be specifically set via the query parameter <em>count</em>.
If the requested <em>count</em> is larger than the available number of events all events are returned.</p>
<div class="language-text codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-text codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/ws/v1/events/batch?count=100</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To prevent a DOS attack the maximum value of <em>count</em> might be limited as part of the implementation.</p>
<p>The second query parameter that will be supported is <em>start</em>.
This specifies the start ID of the first event returned.
Every event is assigned a unique id starting from 0.
The ring buffer maintains the current available highest and lowest ID.
If <em>start</em> refers to an ID which doesn&#x27;t exist in the buffer, then an empty response is returned from the server, with <em>LowestID</em> and <em>HighestID</em> properly filled:</p>
<div class="language-json codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-json codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;InstanceUUID&quot;: &quot;b4751b7d-a1a3-4431-bb68-bff896adb9c2&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;LowestID&quot;: 1100,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;HighestID&quot;: 11000,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;EventRecords&quot;: null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the next request, start should be defined as 1100.</p>
<p>In the response, the <em>InstanceUUID</em> field shows the unique instance ID.
Since YuniKorn is stateless, the generated ID for an event is not saved anywhere.
If an event consumer saves the events to a backend database, it makes it possible to distinguish between events with the same ID.
Also, clients can easily detect that YuniKorn was restarted.</p>
<h4 class="anchor anchorWithStickyNavbar_NlAN" id="streaming">Streaming<a href="#streaming" class="hash-link" aria-label="Direct link to Streaming" title="Direct link to Streaming">​</a></h4>
<p>Streaming allows the user to see a continuous stream of events as they are occurring.
This can be very useful if we want to trace the state changes inside YuniKorn for a longer amount of time.
The REST interface can return the last &quot;n&quot; amount of events that occurred in a certain timeframe, but it will always be limited.
We can only increase the number of events at the expense of memory usage, which might not be acceptable in certain environments.</p>
<p>Although streaming is a nice feature, we do not consider it as a &quot;must have&quot;, at least not in the first version of the history tracking.
This is because it&#x27;s more complicated in nature: it maintains an open HTTP connection towards the client which makes it stateful.
There are ordering and memory usage concerns&amp;considerations.
We need to make sure that rogue clients cannot abuse it.
Therefore, the first release of history tracking focuses on the batch interface.</p>
<p>Streaming needs to coexist beside the current REST api.
A separate endpoint must be exposed for the event stream:</p>
<div class="language-text codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-text codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/ws/v1/events/stream</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Streaming can be similar to how it&#x27;s implemented inside Kubernetes informers.
The API server keeps the connection alive and sends the necessary events about pods, nodes, configmaps, etc.
The incoming data stream is decoded by the listeners.
Event processing on the client side is not part of this design.</p>
<p>At this point we do not provide endpoints for consumers to stream a specific event type as defined in <a href="#event-types">Event types</a>.
This could be made available via separate endpoints in the future following the same design as for <em>batch</em> specification</p>
<p>The <em>stream</em> endpoint does not take any query parameters.
The consumer must allow for more than one (1) event to be sent in one response.
No information besides the events will be sent in the response.</p>
<p>As an example below the approximate output for the stream endpoint for two events</p>
<div class="language-json codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-json codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;type&quot;: 2,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;changeType&quot;: 1,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;changeDetail&quot;: 203,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;timestamp&quot;: 1649167576110750000,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;objectID&quot;: &quot;spark-app-1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;type&quot;: 4,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;changeType&quot;: 2,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;changeDetail&quot;: 405,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;timestamp&quot;: 1649167576110754000,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;objectID&quot;: &quot;root.spark&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;referenceID&quot;: &quot;spark-app-1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="event-overview">Event overview<a href="#event-overview" class="hash-link" aria-label="Direct link to Event overview" title="Direct link to Event overview">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="generic-events">Generic events<a href="#generic-events" class="hash-link" aria-label="Direct link to Generic events" title="Direct link to Generic events">​</a></h3>
<p>The following events are generated for streaming and REST consumers, meaning that they will not be sent to the shim.
This is based on the description of the <a href="#event-system-updates">Event System Updates</a> earlier in this document.
It serves as a reference for the core scheduler actions that will trigger the event.</p>
<table><thead><tr><th>Event type</th><th>Change type</th><th>Change details</th><th>Reference type</th><th>Notes</th></tr></thead><tbody><tr><td>APP</td><td>ADD</td><td>DETAILS_NONE</td><td></td><td>New application added</td></tr><tr><td>APP</td><td>ADD</td><td>APP_ALLOC</td><td>AllocationID</td><td>Successful allocation</td></tr><tr><td>APP</td><td>ADD</td><td>APP_REQUEST</td><td>RequestID</td><td>Incoming resource request (pod)</td></tr><tr><td>APP</td><td>REMOVE</td><td>DETAILS_NONE</td><td></td><td>Normal removal of application</td></tr><tr><td>APP</td><td>REMOVE</td><td>APP_REJECT</td><td></td><td>Application rejected</td></tr><tr><td>APP</td><td>REMOVE</td><td>ALLOC_CANCEL</td><td>AllocationID</td><td>Normal removal requested by the shim</td></tr><tr><td>APP</td><td>REMOVE</td><td>ALLOC_TIMEOUT</td><td>AllocationID</td><td>Timeout</td></tr><tr><td>APP</td><td>REMOVE</td><td>ALLOC_REPLACED</td><td>AllocationID</td><td>Replacement (placeholder)</td></tr><tr><td>APP</td><td>REMOVE</td><td>ALLOC_PREEMPT</td><td>AllocationID</td><td>Preemption triggered</td></tr><tr><td>APP</td><td>REMOVE</td><td>ALLOC_NODEREMOVED</td><td>AllocationID</td><td>Removal triggered by node removal</td></tr><tr><td>APP</td><td>REMOVE</td><td>APP_REQUEST</td><td>RequestID</td><td>Normal removal requested by the shim</td></tr><tr><td>APP</td><td>REMOVE</td><td>REQUEST_TIMEOUT</td><td>RequestID</td><td>Timeout (placeholder)</td></tr><tr><td>APP</td><td>REMOVE</td><td>REQUEST_CANCEL</td><td>RequestID</td><td>Removal triggered by application removal</td></tr><tr><td>APP</td><td>SET</td><td>APP_NEW</td><td></td><td>State change: New</td></tr><tr><td>APP</td><td>SET</td><td>APP_ACCEPTED</td><td></td><td>State change: Accepted</td></tr><tr><td>APP</td><td>SET</td><td>APP_STARTING</td><td></td><td>State change: Starting</td></tr><tr><td>APP</td><td>SET</td><td>APP_RUNNING</td><td></td><td>State change: Running</td></tr><tr><td>APP</td><td>SET</td><td>APP_COMPLETING</td><td></td><td>State change: Completing</td></tr><tr><td>APP</td><td>SET</td><td>APP_COMPLETED</td><td></td><td>State change: Completed</td></tr><tr><td>APP</td><td>SET</td><td>APP_FAILING</td><td></td><td>State change: Failing</td></tr><tr><td>APP</td><td>SET</td><td>APP_FAILED</td><td></td><td>State change: Failed</td></tr><tr><td>APP</td><td>SET</td><td>APP_RESUMING</td><td></td><td>State change: Resuming</td></tr><tr><td>APP</td><td>SET</td><td>APP_EXPIRED</td><td></td><td>State change: Expired</td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr><tr><td>NODE</td><td>ADD</td><td>DETAILS_NONE</td><td></td><td>New node added to the cluster</td></tr><tr><td>NODE</td><td>ADD</td><td>NODE_ALLOC</td><td>AllocationID</td><td>Successful allocation</td></tr><tr><td>NODE</td><td>REMOVE</td><td>NODE_DECOMISSION</td><td></td><td>Removal requested by the shim</td></tr><tr><td>NODE</td><td>REMOVE</td><td>NODE_ALLOC</td><td>AllocationID</td><td>Normal allocation removal requested by the shim</td></tr><tr><td>NODE</td><td>SET</td><td>NODE_READY</td><td></td><td>Update &quot;ready&quot; status</td></tr><tr><td>NODE</td><td>SET</td><td>NODE_SCHEDULABLE</td><td></td><td>Update &quot;schedulable&quot; status</td></tr><tr><td>NODE</td><td>SET</td><td>NODE_CAPACITY</td><td></td><td>Update node capacity</td></tr><tr><td>NODE</td><td>SET</td><td>NODE_OCCUPIED</td><td></td><td>Update occupied resources</td></tr><tr><td>NODE</td><td>ADD</td><td>NODE_RESERVATION</td><td></td><td>Add reservation to a node</td></tr><tr><td>NODE</td><td>REMOVE</td><td>NODE_RESERVATION</td><td></td><td>Remove reservation from a node</td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr><tr><td>QUEUE</td><td>ADD</td><td>DETAILS_NONE</td><td></td><td>Adding new configured queue</td></tr><tr><td>QUEUE</td><td>ADD</td><td>QUEUE_DYNAMIC</td><td></td><td>Adding new dynamic queue</td></tr><tr><td>QUEUE</td><td>ADD</td><td>QUEUE_APP</td><td>ApplicationID</td><td>Application added</td></tr><tr><td>QUEUE</td><td>REMOVE</td><td>DETAILS_NONE</td><td></td><td>Removing configured queue</td></tr><tr><td>QUEUE</td><td>REMOVE</td><td>QUEUE_DYNAMIC</td><td></td><td>Removing dynamic queue</td></tr><tr><td>QUEUE</td><td>REMOVE</td><td>QUEUE_APP</td><td>ApplicationID</td><td>Application removed</td></tr><tr><td>QUEUE</td><td>SET</td><td>QUEUE_MAX</td><td></td><td>Max resource changed</td></tr><tr><td>QUEUE</td><td>SET</td><td>QUEUE_GUARANTEED</td><td></td><td>Guaranteed resource changed</td></tr><tr><td>QUEUE</td><td>SET</td><td>QUEUE_TYPE</td><td></td><td>Queue type change(parent/leaf)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="shim-events-1">Shim events<a href="#shim-events-1" class="hash-link" aria-label="Direct link to Shim events" title="Direct link to Shim events">​</a></h3>
<p>Shim events are a type of REQUEST and the application ID is set.
Right now we send only two types of events to the shim, both of which are originated from the application:</p>
<ul>
<li>Insufficient resources in the queue for a request</li>
<li>Real allocation is larger than placeholder</li>
</ul>
<table><thead><tr><th>Event type</th><th>Change type</th><th>Change details</th><th>Reference type</th><th>Notes</th></tr></thead><tbody><tr><td>REQUEST</td><td>NONE</td><td>DETAILS_NONE</td><td>ApplicationID</td><td>New application added</td></tr><tr><td>REQUEST</td><td>NONE</td><td>DETAILS_NONE</td><td>ApplicationID</td><td>Successful allocation</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="configuration">Configuration<a href="#configuration" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h2>
<p>As part of the design we anticipate the following configuration to be added for the event storage and retrieval.
All settings will have the shared prefix: <em>service.event</em>.
All the mentioned settings will require a restart of the scheduler for updates to take effect.</p>
<p>The following settings will be added to the system:</p>
<p>A flag to enable or disable sending request events to the K8shim.
This externalises the current setting that needs a recompile of the code.
The default mirrors the current default in the code.</p>
<ul>
<li>Name: <strong>requestEventsEnabled</strong></li>
<li>Allowed values: all boolean values will be converted into a boolean using ParseBool as defined in the <code>strconv</code> package<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup>.</li>
<li>Default value: false</li>
</ul>
<p>A flag to enable or disable event collection in the system.
The default is enabled for the tracking events.</p>
<ul>
<li>Name: <strong>trackingEventsEnabled</strong></li>
<li>Allowed values: all boolean values will be converted into a boolean using ParseBool as defined in the <code>strconv</code> package.</li>
<li>Default value: true</li>
</ul>
<p>Size of the store for events that will be sent to the shim, request events.
Note that setting a size of 0 effectively turns off the request event system.</p>
<ul>
<li>Name: <strong>requestStoreCapacity</strong></li>
<li>Allowed values: integer value that can be converted into a 32-bit integer using ParseUint as defined in the <code>strconv</code> package<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup>.</li>
<li>Default value: 1,000</li>
</ul>
<p>The number of events to store in the ring buffer.
This number defines the size of the ring buffer and thus the memory impact the event storage will have on the scheduler.
Note that setting a size of 0 effectively turns off the event collection system.</p>
<ul>
<li>Name: <strong>ringBufferCapacity</strong></li>
<li>Allowed values: integer value that can be converted into a 32-bit integer using ParseUint as defined in the <code>strconv</code> package</li>
<li>Default value: 100,000</li>
</ul>
<p>The maximum number of events to return in one REST response.
The maximum that could be returned is limited to the ring buffer capacity.
However, preparing a large response the size of the whole ring buffer could cause large peaks in the schedulers memory usage.
This setting should be used to prevent these peaks.</p>
<ul>
<li>Name: <strong>RESTResponseSize</strong></li>
<li>Allowed values: integer value that can be converted into a 32-bit integer using ParseUint as defined in the <code>strconv</code> package</li>
<li>Default value: 10,000</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_NlAN" id="performance-considerations">Performance considerations<a href="#performance-considerations" class="hash-link" aria-label="Direct link to Performance considerations" title="Direct link to Performance considerations">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="memory-usage-of-historical-elements">Memory usage of historical elements<a href="#memory-usage-of-historical-elements" class="hash-link" aria-label="Direct link to Memory usage of historical elements" title="Direct link to Memory usage of historical elements">​</a></h3>
<p>We need to estimate how many elements we can expect to be generated with different pod churn rates on a daily basis.
Queue and node events are much rarer, so they are not accounted for.
We also ignore potential failures and scheduling errors.</p>
<p>An application undergoes state transitions, so the following events are generated:</p>
<ul>
<li>Add new application</li>
<li>State change: New</li>
<li>State change: Accepted</li>
<li>State change: Starting</li>
<li>State change: Running</li>
<li>State change: Completing</li>
<li>State change: Completed</li>
<li>Allocation changed</li>
</ul>
<p>Pod (request) events:</p>
<ul>
<li>Incoming allocation request</li>
<li>Successful allocation on a node</li>
</ul>
<p>Pod (request) events with gang scheduling:</p>
<ul>
<li>Incoming resource request</li>
<li>Successful allocation on a node</li>
<li>Replace event for placeholder</li>
</ul>
<table><thead><tr><th>Number of pods</th><th>Number of apps</th><th>Pods per app</th><th>Job type</th><th>Events per app</th><th>Events per pod</th><th>∑ apps</th><th>∑ pods</th><th>∑ events</th></tr></thead><tbody><tr><td>150k</td><td>1500</td><td>100</td><td>normal</td><td>200 + 7</td><td>2</td><td>310k (1500 * 207)</td><td>300k (2 * 150k)</td><td>610k</td></tr><tr><td>150k</td><td>1500</td><td>100</td><td>gang</td><td>300 + 7</td><td>3</td><td>460k (1500 * 307)</td><td>450k (3 * 150k)</td><td>910k</td></tr><tr><td>300k</td><td>3000</td><td>100</td><td>normal</td><td>200 + 7</td><td>2</td><td>621k (3000 * 207)</td><td>600k (2 * 300k)</td><td>1,2M</td></tr><tr><td>300k</td><td>3000</td><td>100</td><td>gang</td><td>300 + 7</td><td>3</td><td>921k (3000 * 307)</td><td>900k (3 * 300k)</td><td>1,8M</td></tr></tbody></table>
<p>On a busy cluster with 150,000 - 300,000 pods per day, we can expect the number of events generated to be around 600k - 1,8M (depending on the scheduling style).</p>
<p>If we want to retain the events for 5 days, we need to store 9 million events in the worst case and 3 million in the best case.</p>
<p>With 9 million objects in the memory, it is also critical to estimate how much extra memory usage is expected from YuniKorn with different kinds of data structures:</p>
<ul>
<li>slice of pointers to si.EventRecord objects <code>[]*si.EventRecord</code></li>
<li>slice of si.EventRecord objects <code>[]si.EventRecord</code></li>
<li>slice of a memory-optimised data type <code>[]internalRecord</code></li>
</ul>
<p>As the name suggests, internalRecord type would only be available inside the ring buffer.
It&#x27;s used together with string interning to save memory caused by repeated strings like IDs (application ID, ask ID, allocation ID, etc.).
There are various interning libraries in Go, but removing elements is not possible from them.
We need to create our own, so we can track the number of references per string.</p>
<p>The following table summarizes memory usage and GC time, depending on how we store the events.
The test was executed multiple times to get averages and ranges.
The slice was created once, then an index variable was increased for each record, so the built-in <code>append()</code> function was not used.</p>
<p>The results clearly indicate two things:</p>
<ul>
<li>having millions of pointers has negative performance on both the memory usage and GC load</li>
<li>batch workloads inherently have a lot of repeated strings, so interning makes a noticeable difference</li>
</ul>
<p>The GC detects pointers, since it has to follow them to walk the object graph to identify unreferenced objects.
If elements in the slice are pointers, then those allocations are scattered all around the heap (bad locality) with header information added by the allocator.
This reduces memory access times and increases the amount of the data that is allocated.</p>
<p>In the test, the assumption was 100 pods per application.
In real life, this value might be different, most likely it&#x27;s lower.
The lower the value, the smaller the advantage of the interning - on the extreme, every application consists of only one pod.
But even with only 30 pods per application, it has value - more modest, 20-30% reductions are not negligible when storing millions of elements.</p>
<table><thead><tr><th>Object type</th><th>Number of elements</th><th>Increased memory usage*</th><th>GC time**</th></tr></thead><tbody><tr><td>[]*si.EventRecord</td><td>3M</td><td>805 MiB</td><td>85-105 ms</td></tr><tr><td>[]si.EventRecord</td><td>3M</td><td>437 MiB</td><td>41-55 ms</td></tr><tr><td>[]internalRecord</td><td>3M</td><td>211 MiB</td><td>5-16 ms</td></tr><tr><td>[]*si.EventRecord</td><td>6M</td><td>1595 MiB</td><td>160-200 ms</td></tr><tr><td>[]si.EventRecord</td><td>6M</td><td>856 MiB</td><td>75-110 ms</td></tr><tr><td>[]internalRecord</td><td>6M</td><td>404 MiB</td><td>10-30 ms</td></tr><tr><td>[]*si.EventRecord</td><td>9M</td><td>2380 MiB</td><td>270-320 ms</td></tr><tr><td>[]si.EventRecord</td><td>9M</td><td>1280 MiB</td><td>116-150 ms</td></tr><tr><td>[]internalRecord</td><td>9M</td><td>593 MiB</td><td>16-33 ms</td></tr></tbody></table>
<p><em>* &quot;Sys&quot; metrics returned by the Go runtime</em></p>
<p><em>** measured by the execution time of <code>runtime.GC()</code></em></p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="handling-slow-and-rogue-clients-during-streaming">Handling slow and rogue clients during streaming<a href="#handling-slow-and-rogue-clients-during-streaming" class="hash-link" aria-label="Direct link to Handling slow and rogue clients during streaming" title="Direct link to Handling slow and rogue clients during streaming">​</a></h3>
<p>It&#x27;s possible to overwhelm YuniKorn with streaming or execute a DoS attack.</p>
<p>The first thing we need to address is a rogue client which simply stops reading on the receiver side from the TCP socket.
Eventually writes will block in YuniKorn.
If we use channels and per-client goroutines, this should not be an issue - we can always check if the buffer is full using the built-in len() function.
If this happens, we can just drop the connection.
In some situations, the buffer is expected to be full, for example, when sending history.
It&#x27;s always faster to send out a lot of existing objects, so we can expect the buffer to get full at times.
This can be solved by repeatedly checking the rate of writes - if it falls below a certain threshold, then again, we just drop the connection with an error message.</p>
<p>We can also limit the number of concurrent streaming connections and historical objects to send, e.g. we simply won&#x27;t serve requests which would result in sending millions of elements.</p>
<p>Note that it&#x27;s still possible to deny the service from legitimate users because YuniKorn lacks authentication on the REST interface.
This will be solved in the future.</p>
<h3 class="anchor anchorWithStickyNavbar_NlAN" id="approaches-to-streaming">Approaches to streaming<a href="#approaches-to-streaming" class="hash-link" aria-label="Direct link to Approaches to streaming" title="Direct link to Approaches to streaming">​</a></h3>
<p>When a client requests a stream of events, it can define how many past events it wants to receive.
This is necessary because when YuniKorn starts up, it&#x27;s not possible to connect immediately.
It can be important for certain users to save the state of YuniKorn on an external storage completely from the start.</p>
<p>Sending the historical events must be separated from the new events that are constantly occurring in the system, that is, old and current events must not interleave.
For example: we want a stream of old and new events, this means:</p>
<ul>
<li>We&#x27;re currently at <em>event<del>n</del></em></li>
<li>Send out events from <em>event<del>0</del></em> all the way up to <em>event<del>n</del></em></li>
<li>In the meantime, <em>k</em> number of events have been generated</li>
<li>Therefore, send events up to event<em><del>n+k</del></em> until we&#x27;re caught up completely</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_NlAN" id="send-history-first-then-stream-new-events"><strong>Send history first, then stream new events</strong><a href="#send-history-first-then-stream-new-events" class="hash-link" aria-label="Direct link to send-history-first-then-stream-new-events" title="Direct link to send-history-first-then-stream-new-events">​</a></h4>
<p>The first approach is to retrieve the objects from the ring buffer and start to send them on a channel to the receiver.
There is a separate buffered channel for new events with capacity <em>localBufferSize</em>.
As soon as we finish sending the history, we switch to this channel and relay events from it towards the client.</p>
<p>We can express this with the following pseudocode:</p>
<div class="language-go codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-go codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">consumerEventLoop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">elementCount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">initLocalEventChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">localBufferSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// send history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    history </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> ringbuffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">getHistory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">elementCount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    foreach h </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> history </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        receiver </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;-</span><span class="token plain"> h</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// bridge new events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    foreach e </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;-</span><span class="token plain">local </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        receiver </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;-</span><span class="token plain"> e</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The publisher logic is:</p>
<div class="language-go codeBlockContainer_l7z8 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_N19i"><pre tabindex="0" class="prism-code language-go codeBlock_adB6 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_fSw7"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">publishEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    foreach c </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> localChannels </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> localBufferSize </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// local buffer full?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">closeChan</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">receiver</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">closeChan</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">local</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            receiverId </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">getReceiver</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">abort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;slow receiver: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> receiverId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        c </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;-</span><span class="token plain"> event</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup_ZiWg"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Gl1a" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mJ2i"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_rLlY"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Each receiver has its own goroutine.
That is, 10 clients means 10 different <code>consumerEventLoop()</code> calls running on separate goroutines.</p>
<p>To detect slow clients, we simply check the value of <code>len(c)</code> whenever we submit the new event.
If this equals the capacity of the buffer, we drop the receiver and close the connection.</p>
<p>It is possible to send events directly to the receiver channel and skip <code>c</code> on the publisher side which is local inside consumerEventLoop.
This requires a simple state machine and a temporary slice of new events, since we are not allowed to send directly as long as the history is being transmitted.
Overall, this is more complicated than the one described above.</p>
<p>The simplicity of this method is notable, which is the main advantage: reasoning about its correctness is trivial.
We do not need complicated test code and back-and-forth review cycles to ensure that it indeed results in the correct order of events.</p>
<p>The biggest question is what happens if channel local becomes full.
Let&#x27;s say that localBufferSize is 1000.
On a busy cluster with 100 events / second (busiest period), it takes 10 seconds to fill it up completely.
However, nothing stops us from setting the capacity of the buffer to a higher value.
If we bump it up to 10000, the client is expected to read the history in 100 seconds.
On a decent network, this amount of time should be enough to read the event history, even if it means 100 000 entries from the ring buffer.
If a single si.EventRecord results in 300 bytes of JSON text, then it is around 30MiB of data.
Even if we take serialisation into account, this will not (can not) take minutes.</p>
<p>The biggest disadvantage of this method is when a user requests a lot of elements from the history.
For example, someone wants to retrieve the last 1M elements.
In this case, we need to allocate a slice for 1M entries.
Based on the measurements, this will generate a sudden spike in the live heap size, around 145-150 MiB. If people repeatedly do this, the memory allocation of YuniKorn can increase very quickly, possibly resulting in a termination of the YuniKorn pod by the kubelet.</p>
<h4 class="anchor anchorWithStickyNavbar_NlAN" id="stream-new-events-directly-from-ring-buffer"><strong>Stream new events directly from ring buffer</strong><a href="#stream-new-events-directly-from-ring-buffer" class="hash-link" aria-label="Direct link to stream-new-events-directly-from-ring-buffer" title="Direct link to stream-new-events-directly-from-ring-buffer">​</a></h4>
<p>Instead of notifying receivers directly, we just insert the data into the ring buffer.
For every client, we create a cursor which points to a given position inside the buffer.
If the pointer is behind the tail, it just keeps reading and going forward until it reaches the current tail.</p>
<p>Although this method sounds simple on the surface, the implementation is complicated:</p>
<ul>
<li>When sending the history, we can&#x27;t rely on <code>len(buf)</code> checking.
It is because when we are sending the history, we are always very close to the capacity.
Unlike the previous solution, we are processing elements from the buffer directly, and we do not bridge two channels.
If we do that, we just add further complications.
Therefore, we have to calculate the sending rate, at least while sending past objects.
If the pointer is not making progress (or just very slow), then the tail of the ring buffer will catch up to it, but it can take a very long time.</li>
<li>In case of multiple cursors, we have to maintain which one is the closest to the tail.
If we don&#x27;t do that, we have to check every cursor when adding elements.
We cannot wait for a slow reader to jump to the next element, so we have to invalidate the cursor, then have to calculate which is the nearest to tail again.</li>
<li>Whenever we reach the last element, we have to block and utilize the well-known wait-notify pattern (<code>Cond.Broadcast()</code> and <code>Cond.Wait()</code> in Go).</li>
<li>The overall sending logic is much more complicated: keep reading batches from the ring buffer until we reach the last element, then switch to wait-notify and block.</li>
</ul>
<p>The advantage of this method is that we don&#x27;t need large channel buffers to make sure that they don&#x27;t get filled while sending historical records.
If the reader is fast enough, we just keep marshalling <code>si.EventRecord</code> objects and bump the pointer to the next element.</p>
<!-- -->
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_NlAN sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-1">
<p><a href="https://pkg.go.dev/strconv#ParseBool" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/strconv#ParseBool</a> <a href="#user-content-fnref-1" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-2">
<p><a href="https://pkg.go.dev/strconv#ParseUint" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/strconv#ParseUint</a> <a href="#user-content-fnref-2" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/1.4.0/design/user_group_resource_usage_enforcement"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">User Based Quota Enforcement</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/1.4.0/design/interface_message_simplification"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Simplifying Interface Messages</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_odww thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non Goals</a></li><li><a href="#existing-event-system" class="table-of-contents__link toc-highlight">Existing Event System</a><ul><li><a href="#scheduler-integration" class="table-of-contents__link toc-highlight">Scheduler integration</a></li><li><a href="#event-storage" class="table-of-contents__link toc-highlight">Event storage</a></li><li><a href="#publishing-events" class="table-of-contents__link toc-highlight">Publishing events</a></li></ul></li><li><a href="#event-system-updates" class="table-of-contents__link toc-highlight">Event System Updates</a><ul><li><a href="#event-description" class="table-of-contents__link toc-highlight">Event description</a></li><li><a href="#event-types" class="table-of-contents__link toc-highlight">Event types</a></li><li><a href="#change-types" class="table-of-contents__link toc-highlight">Change types</a></li><li><a href="#change-details" class="table-of-contents__link toc-highlight">Change details</a></li><li><a href="#content-definition" class="table-of-contents__link toc-highlight">Content definition</a></li></ul></li><li><a href="#event-storage-1" class="table-of-contents__link toc-highlight">Event storage</a><ul><li><a href="#publishing-events-1" class="table-of-contents__link toc-highlight">Publishing events</a></li></ul></li><li><a href="#event-overview" class="table-of-contents__link toc-highlight">Event overview</a><ul><li><a href="#generic-events" class="table-of-contents__link toc-highlight">Generic events</a></li><li><a href="#shim-events-1" class="table-of-contents__link toc-highlight">Shim events</a></li></ul></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#performance-considerations" class="table-of-contents__link toc-highlight">Performance considerations</a><ul><li><a href="#memory-usage-of-historical-elements" class="table-of-contents__link toc-highlight">Memory usage of historical elements</a></li><li><a href="#handling-slow-and-rogue-clients-during-streaming" class="table-of-contents__link toc-highlight">Handling slow and rogue clients during streaming</a></li><li><a href="#approaches-to-streaming" class="table-of-contents__link toc-highlight">Approaches to streaming</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cloudera.com/yunikorn-a-universal-resources-scheduler/" target="_blank" rel="noopener noreferrer" class="footer__link-item">What&#x27;s YuniKorn?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://blog.cloudera.com/spark-on-kubernetes-gang-scheduling-with-yunikorn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Spark on Kubernetes – Gang Scheduling with YuniKorn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Code Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/yunikorn-core/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Core scheduler<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-k8shim" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kubernetes shim<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-scheduler-interface" target="_blank" rel="noopener noreferrer" class="footer__link-item">Scheduler Interface<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-web" target="_blank" rel="noopener noreferrer" class="footer__link-item">WEB application<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-site" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community/get_involved">Get Involved</a></li><li class="footer__item"><a class="footer__link-item" href="/community/people">People</a></li><li class="footer__item"><a href="https://issues.apache.org/jira/projects/YUNIKORN/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_n0Rw"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
<div style="font-size: 70%">
Copyright © 2020-2024 <a href="https://www.apache.org/">The Apache Software Foundation</a>. Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. <br>
<div style="padding:20px; margin: 10px; color: #4d4d4d;">
<p>The Apache Software Foundation Apache YuniKorn, YuniKorn, Apache, the Apache feather, and the Apache YuniKorn project logo are either registered trademarks or trademarks of the Apache Software Foundation.</p>
</div>
</div></div></div></div></footer></div>
</body>
</html>