<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-design/preemption">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Preemption | Apache YuniKorn</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://yunikorn.apache.org/img/logo/yunikorn-logo-main.png"><meta data-rh="true" name="twitter:image" content="https://yunikorn.apache.org/img/logo/yunikorn-logo-main.png"><meta data-rh="true" property="og:url" content="https://yunikorn.apache.org/docs/next/design/preemption"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Preemption | Apache YuniKorn"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/img/yunikorn.ico"><link data-rh="true" rel="canonical" href="https://yunikorn.apache.org/docs/next/design/preemption"><link data-rh="true" rel="alternate" href="https://yunikorn.apache.org/docs/next/design/preemption" hreflang="en"><link data-rh="true" rel="alternate" href="https://yunikorn.apache.org/zh-cn/docs/next/design/preemption" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://yunikorn.apache.org/docs/next/design/preemption" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Q1V951BG2V-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Apache YuniKorn" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e2892fa5.css">
<link rel="preload" href="/assets/js/runtime~main.8d5a74f5.js" as="script">
<link rel="preload" href="/assets/js/main.6047ddba.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">1.3.0 has been released, check the <a href="/community/download">DOWNLOADS</a>.</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo/yunikorn_blue_logo.png" alt="YuniKorn Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo/yunikorn_white_logo.png" alt="YuniKorn Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Apache YuniKorn</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Quick Start</a><a class="navbar__item navbar__link" href="/community/roadmap">Roadmap</a><a class="navbar__item navbar__link" href="/community/download">Download</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community/get_involved">Get Involved</a></li><li><a class="dropdown__link" href="/community/how_to_contribute">How to Contribute</a></li><li><a class="dropdown__link" href="/community/coding_guidelines">Coding Guidelines</a></li><li><a class="dropdown__link" href="/community/reporting_issues">Reporting Issues</a></li><li><a class="dropdown__link" href="/community/release_procedure">Release Procedure</a></li><li><a class="dropdown__link" href="/community/events">Events</a></li><li><a class="dropdown__link" href="/community/people">People</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Apache</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Apache Software Foundation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsors<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy Policy<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/docs">Docs</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/next/">Master</a></li><li><a class="dropdown__link" href="/docs/">1.3.0</a></li><li><a class="dropdown__link" href="/docs/1.2.0/">1.2.0</a></li><li><a class="dropdown__link" href="/docs/1.1.0/">1.1.0</a></li><li><a class="dropdown__link" href="/docs/1.0.0/">1.0.0</a></li><li><a class="dropdown__link" href="/docs/0.12.2/">0.12.2</a></li><li><a class="dropdown__link" href="/docs/0.12.1/">0.12.1</a></li><li><a class="dropdown__link" href="/docs/0.11.0/">0.11.0</a></li><li><a class="dropdown__link" href="/docs/0.10.0/">0.10.0</a></li><li><a class="dropdown__link" href="/docs/0.9.0/">0.9.0</a></li><li><a class="dropdown__link" href="/docs/0.8.0/">0.8.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/next/design/preemption" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/next/design/preemption" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文</a></li></ul></div><a href="https://github.com/apache/yunikorn-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/next/">Get Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/next/user_guide/deployment_modes">User Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/next/developer_guide/env_setup">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/env_setup">Dev Environment Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/build">Build and Run</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/dependencies">Go module updates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/deployment">Deploy to Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/openshift_development">Development in CodeReady Containers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/translation">Translation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/next/design/architecture">Designs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/scheduler_plugin">K8s Scheduler Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/gang_scheduling">Gang scheduling design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/user_group">User/Group handling and lookup design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/user_based_resource_usage_tracking">User Based Resource Usage Tracking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/user_group_resource_usage_enforcement">User Based Quota Enforcement</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/interface_message_simplification">Simplifying Interface Messages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/cache_removal">Scheduler cache removal design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/next/design/preemption">Preemption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/simple_preemptor">DaemonSet Scheduling using Simple Preemptor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/generic_resource">Generic Resource Types in Namespace Quota</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/pluggable_app_management">Pluggable App Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/priority_scheduling">Priority Scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/resilience">Resilience</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/state_aware_scheduling">Batch Workloads Ordering with StateAware Policy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/scheduler_object_states">Scheduler Object States</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/config_v2">Configuration V2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/scheduler_configuration">Scheduler Configuration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/next/archived_design/k8shim">Archived Designs</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/next/performance/evaluate_perf_function_with_kubemark">Performance</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Apache YuniKorn<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/design/preemption">latest version</a></b> (<!-- -->1.3.0<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Designs</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Preemption</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Next</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Preemption</h1></header><h1>Preemption Design</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>This design is created to replace the preemption code that has been part of
YuniKorn for a long time.</p><p>The original code was never fully tested. After the core cache removal as part
of <a href="https://issues.apache.org/jira/browse/YUNIKORN-317" target="_blank" rel="noopener noreferrer">YUNIKORN-317</a> the
preemption code was taken out of the scheduling path. The only changes that
have gone into the preemption code were compilation fixes. As part of the
preparation for the new preemption design the old code was removed in
<a href="https://issues.apache.org/jira/browse/YUNIKORN-1269" target="_blank" rel="noopener noreferrer">YUNIKORN-1269</a>.</p><p>Preemption of workloads is a feature used by almost all schedulers to help
critical workloads run. The criticality can be based on the fact that the
system cannot work without it, i.e. DaemonSets on K8s, or based on some
other factors like SLA or priority. Preemption for DaemonSet pods was
implemented as part of
<a href="https://issues.apache.org/jira/browse/YUNIKORN-1085" target="_blank" rel="noopener noreferrer">YUNIKORN-1085</a>. This
design thus focuses on preemption for all other workloads.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">​</a></h2><ul><li>Re-use existing Kubernetes objects</li><li>Implement inter-queue preemption</li><li>Priority knowledge inside the core scheduler to support preemption</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="non-goals">Non Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non Goals" title="Direct link to Non Goals">​</a></h2><ul><li>Intra-queue preemption</li><li>Cross node preemption</li><li>Full priority support</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preemption-and-priorities">Preemption and Priorities<a href="#preemption-and-priorities" class="hash-link" aria-label="Direct link to Preemption and Priorities" title="Direct link to Preemption and Priorities">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes">Kubernetes<a href="#kubernetes" class="hash-link" aria-label="Direct link to Kubernetes" title="Direct link to Kubernetes">​</a></h3><p>All pods for the entire cluster, across namespaces, are sorted based on
priority for scheduling. A higher-priority will get scheduled before a
lower-priority pod. Preemption within the Kubernetes scheduler is also
based solely on the priority of the pod that is being scheduled. The
full documentation can be found
<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/" target="_blank" rel="noopener noreferrer">here</a>.</p><p>The simple rule that governs both scheduling order and preemption behavior is
that a pod with a higher priority is more important than a pod with a lower
priority. This crosses namespaces. There are no boundaries or limitations
that can be set. Pods from a namespace with a higher priority are scheduled
earlier and could trigger the preemption of a pod from another namespace.</p><p>Priority of a pod is defined in the pod specification. Priority is a number,
but is referenced in the pod specification via a PriorityClass object. The
object defines a named priority and maps it to a value. In more recent
versions (Kubernetes 1.24 and later), the PriorityClass can also contain a
preemption policy for the scheduling phase. This preemptionPolicy only allows
the pod to opt-out from preempting other lower priority pods during the
scheduling phase. It cannot, and is not designed to, alter preemption behavior
while the pod is running.</p><p>The same pod priority is also used during the pod eviction by the kubelet on
the node. For example, if the node has been overloaded and runs out of memory
or CPU, the node can evict pods. These evictions help to keep the node stable.
Pods considered for eviction are ranked on priority among some other factors.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="yunikorn">YuniKorn<a href="#yunikorn" class="hash-link" aria-label="Direct link to YuniKorn" title="Direct link to YuniKorn">​</a></h3><p>The behavior in Kubernetes is all focused on the scheduling cycle. When
looking at preemption from the standpoint of a batch or data processing
workload, we need to take into account the possibility to opt-out while
running. This option does not exist in the current configuration for workloads.</p><p>The simple approach for preemption fits in with the service type workloads
that Kubernetes is designed for. Services handle the scale up and or scale
down that could be triggered by preempting one of the pods for that service.</p><p>This is not the case when we look at a Spark job as an example. The driver pod
is the manager of the other pods that belong to the same job. When the driver
gets preempted the whole job is impacted. Preempting a driver has a follow-on
effect that could cause multiple pods to be removed from the cluster. For a
large job that could mean hundreds of pods. The impact is far larger than a
single pod. Preempting a manager or originator pod should be prevented as much
as possible.</p><p>The other case which we need to account for is an interactive session that
runs on the cluster. This interactive session, like a python notebook, is a
one-off instance and restarts have a wider impact. Preempting an instance
like a notebook is not a desirable outcome either.</p><p>Building in all the smarts to know which pods to avoid is difficult, or even
impossible. For all these cases the option to allow a “do not preempt me” flag
on the pod would be required. The design will discuss this option in the Pod
specification.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="priority-limitations">Priority limitations<a href="#priority-limitations" class="hash-link" aria-label="Direct link to Priority limitations" title="Direct link to Priority limitations">​</a></h3><p>PriorityClass objects which define the priority in a Kubernetes cluster are
cluster-wide objects. The cluster administrator defines the objects and thus
the supported priorities.</p><p>There are no limitations on the priority that can be set on a pod. When a pod
is submitted the only check performed is that the PriorityClass specified as
part of the pod specification is defined. Any rogue user can create a pod with
the highest defined priority.</p><p>Limiting priorities is possible but requires an API server flag which is
difficult to support in public cloud environments. We cannot rely on the option
to be available in a cluster scheduled by YuniKorn.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-laws-of-preemption">The Laws of Preemption<a href="#the-laws-of-preemption" class="hash-link" aria-label="Direct link to The Laws of Preemption" title="Direct link to The Laws of Preemption">​</a></h2><p>Prior knowledge of implementing preemption in the Apache YARN scheduler has
been used to create this design. It forms the basis for the &quot;laws of preemption&quot;.
These laws, or rules, describe overall preemption behavior.</p><p>Preemption for YuniKorn is based on the hierarchical queue model and guaranteed
resources assigned to a queue.</p><p>Preemption is used to get the usage of a queue to at least its guaranteed
resource capacity. It cannot guarantee that every queue will get its
guaranteed resource capacity. There are cases that make it impossible to get to
that state. Preemption therefore does not guarantee a final optimal state can
or will be reached. The end state of the queues will normally thus be a usage
that is approximately the guaranteed resource capacity.</p><p>An example case that makes it impossible to reach the optimal state is when the
sum of the guaranteed resources for a group of queues is larger than the current
resources available in the cluster. It is impossible to get all queues their
guaranteed resources. More cases like this exist in a hierarchy with maximum
quotas set at a certain point in the hierarchy preventing the optimal state from
being reached.</p><p>First an overview of the laws, then the explanation and rationale behind each
of the rules:</p><ol><li>Preemption policies are strong suggestions, not guarantees</li><li>Preemption can never leave a queue lower than its guaranteed capacity</li><li>A task cannot preempt other tasks in the same application</li><li>A task cannot trigger preemption unless its queue is under its guaranteed
capacity</li><li>A task cannot be preempted unless its queue is over its guaranteed capacity</li><li>A task can only preempt a task with lower or equal priority</li><li>A task cannot preempt tasks outside its preemption fence (one-way constraint)</li></ol><p>Most of the rules given around tasks and queues are there to prevent a
preemption storm or loop. Preempting a task that could trigger a follow-up
preemption should be avoided. The rule described should warrant against that.
Breaking the rules could lead to unpredictable behavior either during
scheduling or application runs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="preemption-policies-are-strong-suggestions-not-guarantees">Preemption policies are strong suggestions, not guarantees<a href="#preemption-policies-are-strong-suggestions-not-guarantees" class="hash-link" aria-label="Direct link to Preemption policies are strong suggestions, not guarantees" title="Direct link to Preemption policies are strong suggestions, not guarantees">​</a></h3><p>A pod is able to request not to be preempted. However, this is not a guarantee.
There could be circumstances that the scheduler might still preempt the pod.
This will be a last resort action if no other solution is available. This means
that the preemption policy is a strong suggestion, not a guarantee.</p><p>The example use case that could break the rule and preempt a pod that opted out
of preemption is the DaemonSet case. The DaemonSet pod must run on the specified
node. If all pods that are running on that node are either other DaemonSet pods
or pods that have opted out of preemption there is no other choice. A pod that
opted out of preemption will be preempted.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="preemption-can-never-leave-a-queue-lower-than-its-guaranteed-capacity">Preemption can never leave a queue lower than its guaranteed capacity<a href="#preemption-can-never-leave-a-queue-lower-than-its-guaranteed-capacity" class="hash-link" aria-label="Direct link to Preemption can never leave a queue lower than its guaranteed capacity" title="Direct link to Preemption can never leave a queue lower than its guaranteed capacity">​</a></h3><p>Guaranteed resource capacities configured on a queue are the optimal resources
for the queue from a preemption point of view. Since preemption attempts to get
a queue at least its guaranteed resources, allowing preemption to reduce a queue
below its guaranteed resource capacity would trigger a further round of
preemption.</p><p>When a task is considered for preemption the removal of the task from the
queue&#x27;s usage must not leave the queue below its guaranteed resource capacity.
If the removal of the task would drop the queue below its guarantee that task
cannot be a candidate.</p><p>This could mean that a queue, even when it is above its guarantee, still does
not allow preempting any of the tasks in that queue.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-task-cannot-preempt-other-tasks-in-the-same-application">A task cannot preempt other tasks in the same application<a href="#a-task-cannot-preempt-other-tasks-in-the-same-application" class="hash-link" aria-label="Direct link to A task cannot preempt other tasks in the same application" title="Direct link to A task cannot preempt other tasks in the same application">​</a></h3><p>As part of the current design we are only implementing inter-queue preemption.
This rule does not apply for inter-queue preemption. It is documented here to
make extending to intra-queue preemption possible without a rule change.</p><p>When a task is considered for preemption the task that triggered the preemption
cannot be from the same application.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-task-cannot-trigger-preemption-unless-its-queue-is-under-its-guaranteed-capacity">A task cannot trigger preemption unless its queue is under its guaranteed capacity<a href="#a-task-cannot-trigger-preemption-unless-its-queue-is-under-its-guaranteed-capacity" class="hash-link" aria-label="Direct link to A task cannot trigger preemption unless its queue is under its guaranteed capacity" title="Direct link to A task cannot trigger preemption unless its queue is under its guaranteed capacity">​</a></h3><p>Preemption attempts to get a queue at least its guaranteed resources. Allowing
preemption for a task in a queue that is already over its guaranteed resource
capacity does not help reaching that goal.</p><p>Preemption is not the tool to get a queue to its full maximum resource
capacity. For that reason no tasks in a queue are allowed to trigger
preemption in this case. Normal scheduling will handle the assignment of
resources for queues above their guaranteed capacity.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-task-cannot-be-preempted-unless-its-queue-is-over-its-guaranteed-capacity">A task cannot be preempted unless its queue is over its guaranteed capacity<a href="#a-task-cannot-be-preempted-unless-its-queue-is-over-its-guaranteed-capacity" class="hash-link" aria-label="Direct link to A task cannot be preempted unless its queue is over its guaranteed capacity" title="Direct link to A task cannot be preempted unless its queue is over its guaranteed capacity">​</a></h3><p>This is an extension to the rule that prevents a queue from going below its
guaranteed resource capacity. If a queue is already below its guaranteed
capacity, no tasks running in that queue can be considered for preemption.
The queue can already trigger preemption of tasks from other queues. Allowing
preemption to remove more resources from the queue would cause the queue to be
even further from its ideal usage.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-task-can-only-preempt-a-task-with-lower-or-equal-priority">A task can only preempt a task with lower or equal priority<a href="#a-task-can-only-preempt-a-task-with-lower-or-equal-priority" class="hash-link" aria-label="Direct link to A task can only preempt a task with lower or equal priority" title="Direct link to A task can only preempt a task with lower or equal priority">​</a></h3><p>This rule is linked to the default preemption behavior of Kubernetes. There is
however a slight difference when compared to the Kubernetes rule. Kubernetes
only allows pods to preempt other pods with a lower priority, not with equal
priority.</p><p>Preemption in YuniKorn has a slightly broader application as we also use it to
allow a queue to use its guaranteed resource capacity. The equality has been
added to allow pods from the same priority running in two different queues to
preempt each other. Without that equality allowance on priorities that
redistribution would be slow and difficult.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-task-cannot-preempt-tasks-outside-its-preemption-fence">A task cannot preempt tasks outside its preemption fence<a href="#a-task-cannot-preempt-tasks-outside-its-preemption-fence" class="hash-link" aria-label="Direct link to A task cannot preempt tasks outside its preemption fence" title="Direct link to A task cannot preempt tasks outside its preemption fence">​</a></h3><p>This last rule is a specific multi-tenancy rule. YuniKorn allows setting up a
preemption fence on a queue that will limit the possible tasks that can be
considered for preemption. A task can only preempt another task if it runs on
a queue that is located inside the preemption fence. More on preemption
fencing below.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preemption-fence">Preemption Fence<a href="#preemption-fence" class="hash-link" aria-label="Direct link to Preemption Fence" title="Direct link to Preemption Fence">​</a></h2><p>In a cluster that runs workloads for multiple tenants preemption should not be
allowed to preempt a workload from one tenant and give the resources to
another. A tenant in this case does not have to be a company, it could be a
division or business group within the same company. Tenants map to the queue
hierarchy. The queue hierarchy can thus cross tenant boundaries.</p><p>To translate this to a YuniKorn centric view: confining preemption to assess
only a part of the queue hierarchy should be possible. For this we want to
introduce a preemption fence. The preemption fence is a setting on the queue
which stops preemption from looking at queues outside the fence boundary.</p><p>The preemption fence can be set on any queue at any point in the hierarchy.
It blocks traversing up the queue hierarchy when looking for a victim to
preempt. The fence is a unidirectional fence. It prevents going out (i.e.
higher up the queue hierarchy), but does not prevent coming in (or down) the
queue hierarchy. The below diagram shows an example hierarchy with preemption
fencing applied:</p><p><img loading="lazy" alt="preemption fencing" src="/assets/images/preemption_fence-ed22982d7c96f5c8c24d49c63a76aa80.png" width="1579" height="633" class="img_ev3q"></p><p>The example has three preemption fences defined at different levels. The
arrows describe the preemption flows.</p><p>First look at <code>queue A</code>.
A fence is defined on the leaf queue which means that preemption is fenced to
that queue. This would limit tasks to find a preemption victim within the
queue. This in effect turns off inter-queue preemption for the leaf
<code>queue A</code>. This would be a case for intra-queue preemption only. Note that in
the current design intra-queue preemption is excluded, and we will not
implement this use case. However, we do allow the configuration to be set.</p><p>The second fence is set up at the <code>tenant 1</code> level. This fence has an impact
on the task running in <code>queue B</code>. The tasks in <code>queue B</code> can find a victim
to preempt in all queues below the <code>tenant 1</code> queue (shown in the diagram with
the <em>yellow</em> arrows).</p><p>A similar setup is created for the <code>tenant 2</code> queue. However, in this case
there can be preemption from <code>queue 1</code> to <code>queue 2</code> and vice-versa (shown in
the diagram with the <em>blue</em> arrows).</p><p>None of the tasks running in the queues below <code>tenant 1</code> or <code>tenant 2</code> can
preempt a task from the <code>system</code> queue. Tasks in the <code>system</code> queue are not
fenced. That means that a task in the <code>system</code> queue can check any queue in
the hierarchy (shown in the diagram as the <em>red</em> arrows).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preemption-logic">Preemption Logic<a href="#preemption-logic" class="hash-link" aria-label="Direct link to Preemption Logic" title="Direct link to Preemption Logic">​</a></h2><p>For preemption to be triggered by the default Kubernetes scheduler, the pod
must fit within any namespace quota and no node can be found to allocate the
pod on. Preemption tries to find a node to run the pod on and is focused on
nodes only. All pods on a node with a lower priority are considered candidates
for preemption. The scheduler reduces the candidates to a victim list just
large enough to fit the new pod.</p><p>The scheduler tracks the node undergoing preemption in the pod that triggered
the preemption. It does not guarantee, for a number of reasons, that the pod
that triggered the preemption also gets scheduled on the node the pods were
preempted from.</p><p>From the YuniKorn side we already have a node focused preemption for DaemonSet
pods. A pod from a DaemonSet must run on a specific node. Preemption is
focused on making space on that node. YuniKorn guarantees that the pod will
run on that node and nothing else will be scheduled on that node until the
DaemonSet pod is scheduled.</p><p>Generic preemption in YuniKorn is linked to a queue that is under its
guaranteed quota (<strong>rule 4</strong>). The preemption is only triggered after a delay.
A request must have been pending for at least the preemption delay before
preemption will be considered for it. Instead of looking at a node the first
step is to find victims based on the queue that is over its guaranteed quota
(<strong>rule 5</strong>). If no queues can be found within the preemption fence
(<strong>rule 7</strong>), preemption immediately stops.</p><p>The next step is to build a list of victims. This could be from one or
multiple queues. Any pod with a priority higher (<strong>rule 6</strong>) than the pod
triggering the preemption is discarded. The next step is to discard any pod
with resources larger than the over guarantee portion (<strong>rule 2</strong>). Proximity
of the victim queue in the hierarchy to the originating queue that triggers
the preemption might be considered when we decide which victims to preempt.
Details will be worked out during the implementation phase.</p><p>Cross node preemption is not supported. Any set of victims that get preempted
must run on the same node. The victims are split into groups per node. A group
of victims, combined with the allocatable space on the node, will decide if
the group is a viable group. Checks must be run to make sure that the pod
will fit the node before starting the preemption. If more than one group is
viable a choice will need to be made. The logic for choosing a group is an
implementation detail.</p><p>After choosing a group and indirectly a node, the node is reserved for the
pod. Preemption for the victim list will be triggered and on completion the
pod will be scheduled on the node. The reservation guarantees that the pod
triggering the preemption will be scheduled on that node. As a side effect
the preempted pods that restart can also not “slip back” into the freed up
space on the node while the scheduler waits for all preempted pods to exit.
They could be scheduled on a different node but not stop the pod that
triggered the preemption from being scheduled.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preemption-loop-prevention">Preemption Loop Prevention<a href="#preemption-loop-prevention" class="hash-link" aria-label="Direct link to Preemption Loop Prevention" title="Direct link to Preemption Loop Prevention">​</a></h2><p>The rules defined prevent looping and circular preemptions. Testing should
be added to cover each rule and combinations like below.</p><p>ReplicaSets are a good example to look at for looping and circular
preemption. Each time a pod from a replica set is removed the ReplicaSet
controller will create a new pod to make sure the set is complete. That
auto-recreate could trigger loops if the rules are not covering all cases
correctly. The case described below should be covered as part of standard
testing.</p><p>Example setup: Replica set <em>Prod Repl</em> runs in queue <em>Prod</em>. For testing
a replica set <em>Test Repl</em> runs in the queue <em>Test</em>. Both queues belong
to the same parent queue (they are siblings). The pods all run with the
same settings for priority and preemption. There is no space left on the
cluster.</p><p>Example 1: <em>Prod</em> is under its guaranteed quota and multiple pods of the
replica set are pending. All pods for the <em>Test Repl</em> set are running and
<em>Test</em> is above its guaranteed resource capacity.</p><p>Preemption flow case 1: To make room for a <em>Prod Repl</em> pod, a pod from
the <em>Test Repl</em> set is preempted. Both queues will end up above their
guaranteed resource. The <em>Test Repl</em> pod is recreated. It cannot preempt
the <em>Prod Repl</em> pod as that would leave the <em>Prod</em> queue below its
guaranteed resource capacity. The <em>Test Repl</em> pod will have to wait until
resources become available in the cluster. The other pods for the
<em>Prod Repl</em> set will also have to wait. The <em>Prod</em> queue is now above its
guaranteed resource and cannot trigger preemption anymore.</p><p>Preemption flow case 2: <em>Test</em>, although above its guaranteed resource
capacity, would end up below its guarantee if a pod from <em>Test Repl</em> would be
preempted. No preemption happens and the <em>Prod Repl</em> pods will stay pending
until space becomes available in the cluster.</p><p>Preemption flow case 3: To make room for the <em>Prod Repl</em> pod a pod from the
<em>Test Repl</em> set is preempted. The <em>Prod</em> queue, even with the additional pod,
is still below its guaranteed resource. The <em>Test Repl</em> pod is recreated.
<em>Prod</em> is not considered as a queue with victims as it is still below its
guaranteed resources. The <em>Test Repl</em> pod will have to wait until resources
become available in the cluster. The <em>Prod</em> queue can trigger further
preemptions. Preemption checks start from scratch. Depending on the state this
could trigger none or more preemptions from the Test queue.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preemption-configuration">Preemption Configuration<a href="#preemption-configuration" class="hash-link" aria-label="Direct link to Preemption Configuration" title="Direct link to Preemption Configuration">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="priorityclass">PriorityClass<a href="#priorityclass" class="hash-link" aria-label="Direct link to PriorityClass" title="Direct link to PriorityClass">​</a></h3><p>As part of the pod specification we need to be able to provide the ability to
opt-out of preemption. Allowing a user to specify the opt-out directly on the
pod independent of the priority causes a disconnect between Kubernetes and
YuniKorn preemption configuration. It also removes control from the
administrator of the cluster to define which priorities should not be able
to opt out.</p><p>One of the goals of the design is to not introduce new objects in Kubernetes.
Combined with the above control and management of the opt-out functionality
at a cluster level the design reuses the existing PriorityClass object.
We cannot and must not break existing functionality of the default Kubernetes
scheduler when we do this. The plugin version of Kubernetes relies on the
default scheduler and its behavior. Pods will use the priorityClassName just
like standard Kubernetes.</p><p>The PriorityClass object allows specifying a <em>preemptionPolicy</em> with two
possible values:</p><ul><li>PreemptLowerPriority</li><li>Never</li></ul><p>The values are hard-coded in the core types and validations. Adding a new
value is not possible without making a Kubernetes change. That means we cannot
reuse the <em>preemptionPolicy</em> field itself. The content of the field will be
propagated to the scheduling core to allow YuniKorn to take the setting into
account while scheduling.</p><p>Just like all other objects in Kubernetes, the PriorityClass object extends
the base object and includes metadata. As part of the metadata we can set
labels and or annotations on the object. Labels are more restrictive than
annotations. As a generic rule we prefer to use annotations over labels for
all the extensions we are adding.</p><p>The proposal is to add an annotation to the PriorityClass that allows an
opt-out of preemption. The name of the annotation would follow the same
structure as we use for all other annotations:
<code>yunikorn.apache.org/allow-preemption</code></p><p>As the value of the annotation the proposal is to use a boolean value:</p><ul><li>&quot;true&quot;:	allow the pod to be preempted,</li><li>&quot;false&quot;:	do not allow preemption
If no value is set for <em>allow-preemption</em> the default value <em>true</em> is used.</li></ul><p>The design comes with a caveat. The value of &quot;<em>false</em>&quot; for the annotation
on the PriorityClass provides the possibility for a pod to request not to
be preempted. However, this is not a guarantee. There could be
circumstances that the scheduler might still preempt the pod. This will be
a last resort action if no other solution is available. This means that the
preemption policy as defined above is a strong suggestion, not a guarantee.</p><p>The example use case that could break the rule and preempt a pod with
<em>allow-preemption</em> set to <em>false</em> is the DaemonSet case. The DaemonSet pod
must run on the specified node. If all pods that are running on that node
are either other DaemonSet pods or pods that have <em>allow-preemption</em> set
to <em>false</em> there is no other choice. A pod that opted out of preemption
will be preempted.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="application-settings">Application Settings<a href="#application-settings" class="hash-link" aria-label="Direct link to Application Settings" title="Direct link to Application Settings">​</a></h3><p>Priority is part of the pod specification on Kubernetes. Every pod is
converted into an AllocationAsk by the k8shim. As part of the DaemonSet
preemption that was implemented in
<a href="https://issues.apache.org/jira/browse/YUNIKORN-1085" target="_blank" rel="noopener noreferrer">YUNIKORN-1085</a> the
priority of a pod is read and set on the AllocationAsk that is created. The
priority that is passed on currently is just a plain integer value, we do not
need more than that.</p><p>As part of preemption we need two additional values to be passed on. These two
values together form the preemptionPolicy for YuniKorn. The values must be
communicated as part of the AllocationAsk sent from the Kubernetes shim to the
core. Both values are mapped to the content of the PriorityClass described above.
Instead of adding two separate fields, wrapping them into a new message will
provide more clarity.</p><p>The preemption policy can be processed for any AllocationAsk, even if it has
the <code>Originator</code> flag in the message set to <em>false</em>. Specifying different
preemption behavior for different asks within an application could be important
to allow low-cost asks to be preempted while high-cost asks opt-out.</p><p>The use case is again a Spark application. You want the driver pod to opt-out
from preemption and, possibly, preempt other pods during scheduling. An executor
should do neither.</p><p>In protobuf message form that would look like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">message AllocationAsk {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // The preemption policy for this ask</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  PreemptionPolicy preemptionPolicy = 12;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message PreemptionPolicy {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // Allow preemption while running</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // Based on the YuniKorn annotation from the PriorityClass object</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  bool allowPreemption = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // Preemption behavior while scheduling</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // Based on the K8s preemptionPolicy from the PriorityClass object</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string schedulerPreemption = 2;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue-configuration">Queue Configuration<a href="#queue-configuration" class="hash-link" aria-label="Direct link to Queue Configuration" title="Direct link to Queue Configuration">​</a></h3><p>Two new attributes will be added to the queue configuration object to allow
specifying the preemption fence type and preemption delay. Both properties,
<code>preemption.policy</code> and <code>preemption.delay</code>, can be set on any queue. The
attributes are part of the queue properties as follows:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">queues</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> fencedqueue</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">preemption.policy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> fence</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">preemption.delay</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 30s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Properties are fully supported in child templates. Support for setting these
properties for dynamic queues is included as part of the existing
functionality.</p><p>The <em>preemption.policy</em> property can be set on the root queue but has no effect.
The root queue as the top of the hierarchy has no parent. This means preemption
cannot traverse further up the tree. No messages will be logged if the
<em>preemption.policy</em> is set on the root queue.</p><p>The supported values for the <em>preemption.policy</em> are:</p><ul><li>default</li><li>fence</li><li>disabled</li></ul><p>If the value <code>fence</code> is set on a queue, tasks running in or below the queue on
which the property is set cannot preempt tasks outside the queue tree. The
value <code>default</code> does not limit preemption to the subtree. If no policy is set
the value <code>default</code> is used.</p><p>A <em>preemption.delay</em> can only be set on a leaf queue. The leaf queue contains
the tasks. Tasks trigger the preemption in combination with a queue being below
its guaranteed resource capacity. Setting a preemption delay on a queue that is
not a leaf has no effect. No messages will be logged if a <em>preemption.delay</em> is
set on a parent queue.</p><p>The <em>preemption.delay</em> value must be a valid Golang duration in string form. The
value will be converted into a duration using <code>ParseDuration</code> as defined in the
time package.</p><p>A <em>preemption.delay</em>, if specified, must be larger than <code>0s</code>. If no
<em>preemption.delay</em> property is specified in the queue the default of <code>30s</code> is
used. If parsing of the string fails the default of <code>30s</code> is used.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scheduler-storage-object-changes">Scheduler storage object changes<a href="#scheduler-storage-object-changes" class="hash-link" aria-label="Direct link to Scheduler storage object changes" title="Direct link to Scheduler storage object changes">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="allocationask">AllocationAsk<a href="#allocationask" class="hash-link" aria-label="Direct link to AllocationAsk" title="Direct link to AllocationAsk">​</a></h3><p>In line with the changes for the communication the objects in the scheduler also
need to be modified to persist some of the detail communicated. For the
AllocationAsk we need to store both new fields.</p><p>Proposed new fields: <em>allowPreemption</em> and <em>schedulerPreemption</em></p><ul><li><em>schedulerPreemption</em> is only used during the scheduling phase.  </li><li><em>allowPreemption</em> will be propagated to the resulting allocation as defined
below.  </li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="allocation">Allocation<a href="#allocation" class="hash-link" aria-label="Direct link to Allocation" title="Direct link to Allocation">​</a></h3><p>The allocation that gets created based on the AllocationAsk needs a new field.
This removes the need to check the underlying AllocationAsk if it allows
preemption or not. The scheduler preemption value is not required in the
Allocation.</p><p>Proposed new field: <em>allowPreemption</em>  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue">Queue<a href="#queue" class="hash-link" aria-label="Direct link to Queue" title="Direct link to Queue">​</a></h3><p>The new preemption policy and delay values will need to be stored in the Queue
object. The configuration object does not change as we use the properties of
the Queue in the configuration to store them.</p><p>Proposed new fields: <em>preemptionPolicy</em> and <em>preemptionDelay</em></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/next/design/cache_removal"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Scheduler cache removal design</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/next/design/simple_preemptor"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">DaemonSet Scheduling using Simple Preemptor</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non Goals</a></li><li><a href="#preemption-and-priorities" class="table-of-contents__link toc-highlight">Preemption and Priorities</a><ul><li><a href="#kubernetes" class="table-of-contents__link toc-highlight">Kubernetes</a></li><li><a href="#yunikorn" class="table-of-contents__link toc-highlight">YuniKorn</a></li><li><a href="#priority-limitations" class="table-of-contents__link toc-highlight">Priority limitations</a></li></ul></li><li><a href="#the-laws-of-preemption" class="table-of-contents__link toc-highlight">The Laws of Preemption</a><ul><li><a href="#preemption-policies-are-strong-suggestions-not-guarantees" class="table-of-contents__link toc-highlight">Preemption policies are strong suggestions, not guarantees</a></li><li><a href="#preemption-can-never-leave-a-queue-lower-than-its-guaranteed-capacity" class="table-of-contents__link toc-highlight">Preemption can never leave a queue lower than its guaranteed capacity</a></li><li><a href="#a-task-cannot-preempt-other-tasks-in-the-same-application" class="table-of-contents__link toc-highlight">A task cannot preempt other tasks in the same application</a></li><li><a href="#a-task-cannot-trigger-preemption-unless-its-queue-is-under-its-guaranteed-capacity" class="table-of-contents__link toc-highlight">A task cannot trigger preemption unless its queue is under its guaranteed capacity</a></li><li><a href="#a-task-cannot-be-preempted-unless-its-queue-is-over-its-guaranteed-capacity" class="table-of-contents__link toc-highlight">A task cannot be preempted unless its queue is over its guaranteed capacity</a></li><li><a href="#a-task-can-only-preempt-a-task-with-lower-or-equal-priority" class="table-of-contents__link toc-highlight">A task can only preempt a task with lower or equal priority</a></li><li><a href="#a-task-cannot-preempt-tasks-outside-its-preemption-fence" class="table-of-contents__link toc-highlight">A task cannot preempt tasks outside its preemption fence</a></li></ul></li><li><a href="#preemption-fence" class="table-of-contents__link toc-highlight">Preemption Fence</a></li><li><a href="#preemption-logic" class="table-of-contents__link toc-highlight">Preemption Logic</a></li><li><a href="#preemption-loop-prevention" class="table-of-contents__link toc-highlight">Preemption Loop Prevention</a></li><li><a href="#preemption-configuration" class="table-of-contents__link toc-highlight">Preemption Configuration</a><ul><li><a href="#priorityclass" class="table-of-contents__link toc-highlight">PriorityClass</a></li><li><a href="#application-settings" class="table-of-contents__link toc-highlight">Application Settings</a></li><li><a href="#queue-configuration" class="table-of-contents__link toc-highlight">Queue Configuration</a></li></ul></li><li><a href="#scheduler-storage-object-changes" class="table-of-contents__link toc-highlight">Scheduler storage object changes</a><ul><li><a href="#allocationask" class="table-of-contents__link toc-highlight">AllocationAsk</a></li><li><a href="#allocation" class="table-of-contents__link toc-highlight">Allocation</a></li><li><a href="#queue" class="table-of-contents__link toc-highlight">Queue</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cloudera.com/yunikorn-a-universal-resources-scheduler/" target="_blank" rel="noopener noreferrer" class="footer__link-item">What&#x27;s YuniKorn?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://blog.cloudera.com/spark-on-kubernetes-gang-scheduling-with-yunikorn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Spark on Kubernetes – Gang Scheduling with YuniKorn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Code Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/yunikorn-core/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Core scheduler<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-k8shim" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kubernetes shim<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-scheduler-interface" target="_blank" rel="noopener noreferrer" class="footer__link-item">Scheduler Interface<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-web" target="_blank" rel="noopener noreferrer" class="footer__link-item">WEB application<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/yunikorn-site" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community/get_involved">Get Involved</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/next/design/community/people">People</a></li><li class="footer__item"><a href="https://issues.apache.org/jira/projects/YUNIKORN/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
<div style="font-size: 70%">
Copyright © 2020-2023 <a href="https://www.apache.org/">The Apache Software Foundation</a>. Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. <br>
<div style="padding:20px; margin: 10px; color: #4d4d4d;">
<p>The Apache Software Foundation Apache YuniKorn, YuniKorn, Apache, the Apache feather, and the Apache YuniKorn project logo are either registered trademarks or trademarks of the Apache Software Foundation.</p>
</div>
</div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.8d5a74f5.js"></script>
<script src="/assets/js/main.6047ddba.js"></script>
</body>
</html>