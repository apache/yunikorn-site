"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[80574],{11703:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>s});var o=t(96363);const i={},a=o.createContext(i);function r(e){const n=o.useContext(a);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(a.Provider,{value:n},e.children)}},79113:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>u});const o=JSON.parse('{"id":"user_guide/quota_preemption","title":"Quota Preemption","description":"\x3c!--","source":"@site/docs/user_guide/quota_preemption.md","sourceDirName":"user_guide","slug":"/user_guide/quota_preemption","permalink":"/docs/next/user_guide/quota_preemption","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"quota_preemption","title":"Quota Preemption"},"sidebar":"docs","previous":{"title":"Preemption","permalink":"/docs/next/user_guide/preemption_cases"},"next":{"title":"ACLs","permalink":"/docs/next/user_guide/acls"}}');var i=t(47259),a=t(11703);const r={id:"quota_preemption",title:"Quota Preemption"},s=void 0,l={},u=[{value:"Global configuration",id:"global-configuration",level:2},{value:"Queue configuration",id:"queue-configuration",level:2},{value:"Recommendations",id:"recommendations",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Queues can be configured with a quota. The quota for a queue can be changed while the system is running. In the case that a quota is changed the new quota is applied immediately in the next scheduling cycle. Depending on the type of change there are different impacts."}),"\n",(0,i.jsx)(n.p,{children:"For a queue that had its quota increased: no impact. The queue could not have used more than its old quota and the new quota is higher providing more resources to be allocated by the workloads running in the queue."}),"\n",(0,i.jsx)(n.p,{children:"For a queue that had its quota decreased there are two cases."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"the new, lowered, quota is larger than the current usage in the queue: no impact. Workloads will be allocated until the new quota is reached. All running workloads are unaffected."}),"\n",(0,i.jsx)(n.li,{children:"the new, lowered, quota is smaller than the current usage in the queue: the queue is impacted. Any workloads that were pending in the queue will need to wait until resources become available. Workloads will keep on running until they are done."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["This second case is what is targeted by quota preemption. Quota preemption provides the administrator the option to intervene in the running workload when lowering a quota.\nThis document guide users to set up preemption delay for more details on the design, please refer ",(0,i.jsx)(n.a,{href:"/docs/next/design/quota_change_enforcement_through_preemption",children:"design doc"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"global-configuration",children:"Global configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Quota preemption is available in YuniKorn 1.8 or later and turned ",(0,i.jsx)(n.code,{children:"off"})," by default."]}),"\n",(0,i.jsx)(n.p,{children:"To turn on quota preemption it must be turned on globally at the partition level first in the YuniKorn config:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"partitions:\n  - name: <name of the partition>\n    preemption:\n      quotapreemptionenabled: <boolean value>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The default value for ",(0,i.jsx)(n.em,{children:"quotapreemptionenabled"})," is ",(0,i.jsx)(n.em,{children:"false"}),". Allowed values: ",(0,i.jsx)(n.em,{children:"true"})," or ",(0,i.jsx)(n.em,{children:"false"}),", any other value will cause a parse error."]}),"\n",(0,i.jsx)(n.p,{children:"When quota preemption is turned on at the partition level quota changes could trigger a preemption when a queue quota is changed."}),"\n",(0,i.jsx)(n.h2,{id:"queue-configuration",children:"Queue configuration"}),"\n",(0,i.jsxs)(n.p,{children:["With the global configuration is turned on each queue must be configured to opt in to quota preemption. A queue can opt in by setting the ",(0,i.jsx)(n.em,{children:"quota.preemption.delay"})," property on the queue."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"queues:\n  - name: default\n    properties:\n      quota.preemption.delay: <delay string>\n"})}),"\n",(0,i.jsx)(n.p,{children:"The delay when not specified defaults to 0. A delay value explicitly set to 0 will prevent the quota change of the queue from triggering preemption.\nAny non-zero value for the delay will be added to the time the change of the quota was applied to the queue. That timestamp defines the trigger point for quota preemption.\nQuota preemption will only be triggered if the queue at the point in time of the change is above the new quota.\nThe standard scheduling quota enforcement will immediately enforce the new quota in all other cases and no further preemption actions are needed."}),"\n",(0,i.jsx)(n.p,{children:"The scheduler will not trigger quota preemption until the delay has passed. If at that point in time the queue usage has dropped below the quota set, no actions will be taken.\nThe quota preemption tracking information will be cleaned up in that case."}),"\n",(0,i.jsx)(n.p,{children:"To prevent multiple quota changes from impacting each other quota preemption works top down in the queue hierarchy. If a change of a quota has triggered preemption on a queue none of the children of that queue will be able to trigger quota preemption.\nThis prevents complex victim selection interactions if multiple changes are made."}),"\n",(0,i.jsxs)(n.p,{children:["Victims for quota preemption can come from any queue below the queue that triggered the quota preemption. Quota preemption follows the same rules for victim selection as normal preemption.\nIt cannot cause a queue to go below its guaranteed, allocations are sorted based on priority and can opt out. See the description in the ",(0,i.jsx)(n.a,{href:"/docs/next/user_guide/preemption_cases",children:"preemption documentation"})," for details."]}),"\n",(0,i.jsx)(n.p,{children:'An example configuration turning on quota preemption and setting a delay of 15 minutes on the "prod" queue:'}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"partitions:\n  - name: default\n    preemption:\n      quotapreemptionenabled: true\n    queues:\n      - name: root\n        queues:\n          - name: prod\n            parent: false\n            resources:\n              max:\n                {memory: 10T, vcore: 1000}\n            properties:\n              quota.preemption.delay: 15m\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Dynamic Queues",type:"note",children:(0,i.jsx)(n.p,{children:"Dynamic queues do not support quota preemption."})}),"\n",(0,i.jsx)(n.admonition,{title:"Inheritance",type:"note",children:(0,i.jsxs)(n.p,{children:["The current configuration does not support inheritance of the ",(0,i.jsx)(n.em,{children:"quota.preemption.delay"})," value.\n",(0,i.jsx)(n.a,{href:"https://issues.apache.org/jira/browse/YUNIKORN-3208",children:"YUNIKORN-3208"})," has been logged to support that functionality."]})}),"\n",(0,i.jsx)(n.h2,{id:"recommendations",children:"Recommendations"}),"\n",(0,i.jsx)(n.p,{children:"Quota preemption should be used with care. Using short delays is not recommended. Although no minimum delay is enforced any delay below a minute (60 seconds) should not be used."}),"\n",(0,i.jsx)(n.p,{children:"If a queue mainly runs service type workloads up and down scaling of deployments should be considered when changing quotas. Workloads will not exit automatically and will be restarted if preempted.\nUsing quota preemption could cause the service to be left in a degraded state. The controller will also try to recreate the workload."}),"\n",(0,i.jsx)(n.p,{children:"When running batch workloads, the delay should be based on the runtime of the workloads. Preempting workloads should be a last resort.\nA workload that finishes automatically lowers the queue usage and will not require to be re-run. Preempted workloads have already used resources and will be more expensive overall."}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"For consistency: until inheritance is provided setting a delay on a parent queue should not be set unless all children below it are also updated with the same delay."})})]})}function c(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);