"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2075],{24332:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var t=o(13274),i=o(1780);const r={id:"deployment",title:"Deploy to Kubernetes"},l=void 0,s={id:"developer_guide/deployment",title:"Deploy to Kubernetes",description:"\x3c!--",source:"@site/versioned_docs/version-0.12.2/developer_guide/deployment.md",sourceDirName:"developer_guide",slug:"/developer_guide/deployment",permalink:"/docs/0.12.2/developer_guide/deployment",draft:!1,unlisted:!1,tags:[],version:"0.12.2",frontMatter:{id:"deployment",title:"Deploy to Kubernetes"},sidebar:"docs",previous:{title:"Build and Run",permalink:"/docs/0.12.2/developer_guide/build"},next:{title:"Development in CodeReady Containers",permalink:"/docs/0.12.2/developer_guide/openshift_development"}},d={},c=[{value:"Build docker image",id:"build-docker-image",level:2},{value:"Setup RBAC",id:"setup-rbac",level:2},{value:"Create the ConfigMap",id:"create-the-configmap",level:2},{value:"Attach ConfigMap to the Scheduler Pod",id:"attach-configmap-to-the-scheduler-pod",level:2},{value:"Deploy the Scheduler",id:"deploy-the-scheduler",level:2},{value:"Access to the web UI",id:"access-to-the-web-ui",level:2},{value:"Configuration Hot Refresh",id:"configuration-hot-refresh",level:2}];function a(e){const n={a:"a",code:"code",em:"em",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["The easiest way to deploy YuniKorn is to leverage our ",(0,t.jsx)(n.a,{href:"https://hub.helm.sh/charts/yunikorn/yunikorn",children:"helm charts"}),",\nyou can find the guide ",(0,t.jsx)(n.a,{href:"/docs/0.12.2/",children:"here"}),". This document describes the manual process to deploy YuniKorn\nscheduler and it is majorly for developers."]}),"\n",(0,t.jsx)(n.h2,{id:"build-docker-image",children:"Build docker image"}),"\n",(0,t.jsxs)(n.p,{children:["Under project root of the ",(0,t.jsx)(n.code,{children:"yunikorn-k8shim"}),", run the command to build an image using the map for the configuration:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"make image\n"})}),"\n",(0,t.jsx)(n.p,{children:"This command will build an image. The image will be tagged with a default version and image tag."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note"})," the default build uses a hardcoded user and tag. You ",(0,t.jsx)(n.em,{children:"must"})," update the ",(0,t.jsx)(n.code,{children:"IMAGE_TAG"})," variable in the ",(0,t.jsx)(n.code,{children:"Makefile"})," to push to an appropriate repository."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note"})," the latest yunikorn images in docker hub are not updated anymore due to ASF policy. Hence, you should build both scheduler image and web image locally before deploying them."]}),"\n",(0,t.jsx)(n.h2,{id:"setup-rbac",children:"Setup RBAC"}),"\n",(0,t.jsxs)(n.p,{children:["The first step is to create the RBAC role for the scheduler, see ",(0,t.jsx)(n.a,{href:"https://github.com/apache/incubator-yunikorn-k8shim/blob/master/deployments/scheduler/yunikorn-rbac.yaml",children:"yunikorn-rbac.yaml"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl create -f scheduler/yunikorn-rbac.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"The role is a requirement on the current versions of kubernetes."}),"\n",(0,t.jsx)(n.h2,{id:"create-the-configmap",children:"Create the ConfigMap"}),"\n",(0,t.jsx)(n.p,{children:"This must be done before deploying the scheduler. It requires a correctly setup kubernetes environment.\nThis kubernetes environment can be either local or remote."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"download configuration file if not available on the node to add to kubernetes:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"curl -o queues.yaml https://raw.githubusercontent.com/apache/incubator-yunikorn-k8shim/master/conf/queues.yaml\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"create ConfigMap in kubernetes:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl create configmap yunikorn-configs --from-file=queues.yaml\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"check if the ConfigMap was created correctly:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl describe configmaps yunikorn-configs\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note"})," if name of the ConfigMap is changed the volume in the scheduler yaml file must be updated to reference the new name otherwise the changes to the configuration will not be picked up."]}),"\n",(0,t.jsx)(n.h2,{id:"attach-configmap-to-the-scheduler-pod",children:"Attach ConfigMap to the Scheduler Pod"}),"\n",(0,t.jsx)(n.p,{children:"The ConfigMap is attached to the scheduler as a special volume. First step is to specify where to mount it in the pod:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"  volumeMounts:\n    - name: config-volume\n      mountPath: /etc/yunikorn/\n"})}),"\n",(0,t.jsx)(n.p,{children:"Second step is to link the mount point back to the configuration map created in kubernetes:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"  volumes:\n    - name: config-volume\n      configMap:\n        name: yunikorn-configs\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Both steps are part of the scheduler yaml file, an example can be seen at ",(0,t.jsx)(n.a,{href:"https://github.com/apache/incubator-yunikorn-k8shim/blob/master/deployments/scheduler/scheduler.yaml",children:"scheduler.yaml"}),"\nfor reference."]}),"\n",(0,t.jsx)(n.h2,{id:"deploy-the-scheduler",children:"Deploy the Scheduler"}),"\n",(0,t.jsx)(n.p,{children:"The scheduler can be deployed with following command."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl create -f deployments/scheduler/scheduler.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"The deployment will run 2 containers from your pre-built docker images in 1 pod,"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"yunikorn-scheduler-core (yunikorn scheduler core and shim for K8s)"}),"\n",(0,t.jsx)(n.li,{children:"yunikorn-scheduler-web (web UI)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The pod is deployed as a customized scheduler, it will take the responsibility to schedule pods which explicitly specifies ",(0,t.jsx)(n.code,{children:"schedulerName: yunikorn"})," in pod's spec. In addition to the ",(0,t.jsx)(n.code,{children:"schedulerName"}),", you will also have to add a label ",(0,t.jsx)(n.code,{children:"applicationId"})," to the pod."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"  metadata:\n    name: pod_example\n    labels:\n      applicationId: appID\n  spec:\n    schedulerName: yunikorn\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Note: Admission controller abstracts the addition of ",(0,t.jsx)(n.code,{children:"schedulerName"})," and ",(0,t.jsx)(n.code,{children:"applicationId"})," from the user and hence, routes all traffic to YuniKorn. If you use helm chart to deploy, it will install admission controller along with the scheduler."]}),"\n",(0,t.jsx)(n.h2,{id:"access-to-the-web-ui",children:"Access to the web UI"}),"\n",(0,t.jsx)(n.p,{children:"When the scheduler is deployed, the web UI is also deployed in a container.\nPort forwarding for the web interface on the standard ports can be turned on via:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'POD=`kubectl get pod -l app=yunikorn -o jsonpath="{.items[0].metadata.name}"` && \\\nkubectl port-forward ${POD} 9889 9080\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"9889"})," is the default port for Web UI, ",(0,t.jsx)(n.code,{children:"9080"})," is the default port of scheduler's Restful service where web UI retrieves info from.\nOnce this is done, web UI will be available at: ",(0,t.jsx)(n.a,{href:"http://localhost:9889",children:"http://localhost:9889"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"configuration-hot-refresh",children:"Configuration Hot Refresh"}),"\n",(0,t.jsxs)(n.p,{children:["YuniKorn supports to load configuration changes automatically from attached configmap. Simply update the content in the configmap,\nthat can be done either via Kubernetes dashboard UI or commandline. ",(0,t.jsx)(n.em,{children:"Note"}),", changes made to the configmap might have some\ndelay to be picked up by the scheduler."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},1780:(e,n,o)=>{o.d(n,{R:()=>l,x:()=>s});var t=o(79474);const i={},r=t.createContext(i);function l(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);