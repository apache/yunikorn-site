"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[76709],{46344:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>t,metadata:()=>i,toc:()=>d});var r=n(13274),a=n(1780);const t={id:"run_spark",title:"Run Spark Jobs",description:"How to run Spark jobs with YuniKorn",keywords:["spark"]},o=void 0,i={id:"user_guide/workloads/run_spark",title:"Run Spark Jobs",description:"How to run Spark jobs with YuniKorn",source:"@site/versioned_docs/version-0.12.2/user_guide/workloads/run_spark.md",sourceDirName:"user_guide/workloads",slug:"/user_guide/workloads/run_spark",permalink:"/docs/0.12.2/user_guide/workloads/run_spark",draft:!1,unlisted:!1,tags:[],version:"0.12.2",frontMatter:{id:"run_spark",title:"Run Spark Jobs",description:"How to run Spark jobs with YuniKorn",keywords:["spark"]},sidebar:"docs",previous:{title:"Gang Scheduling",permalink:"/docs/0.12.2/user_guide/gang_scheduling"},next:{title:"Run Flink Jobs",permalink:"/docs/0.12.2/user_guide/workloads/run_flink"}},c={},d=[{value:"Prepare the docker image for Spark",id:"prepare-the-docker-image-for-spark",level:2},{value:"Create a namespace for Spark jobs",id:"create-a-namespace-for-spark-jobs",level:2},{value:"Submit a Spark job",id:"submit-a-spark-job",level:2},{value:"What happens behind the scenes?",id:"what-happens-behind-the-scenes",level:2}];function l(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["This document assumes you have YuniKorn and its admission-controller both installed. Please refer to\n",(0,r.jsx)(s.a,{href:"/docs/0.12.2/",children:"get started"})," to see how that is done."]})}),"\n",(0,r.jsx)(s.h2,{id:"prepare-the-docker-image-for-spark",children:"Prepare the docker image for Spark"}),"\n",(0,r.jsx)(s.p,{children:"To run Spark on Kubernetes, you'll need the Spark docker images. You can 1) use the docker images provided by the YuniKorn\nteam, or 2) build one from scratch. If you want to build your own Spark docker image, you can"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Download a Spark version that has Kubernetes support, URL: ",(0,r.jsx)(s.a,{href:"https://github.com/apache/spark",children:"https://github.com/apache/spark"})]}),"\n",(0,r.jsx)(s.li,{children:"Build spark with Kubernetes support:"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell",metastring:"script",children:"mvn -Pyarn -Phadoop-2.7 -Dhadoop.version=2.7.4 -Phive -Pkubernetes -Phive-thriftserver -DskipTests package\n"})}),"\n",(0,r.jsx)(s.h2,{id:"create-a-namespace-for-spark-jobs",children:"Create a namespace for Spark jobs"}),"\n",(0,r.jsx)(s.p,{children:"Create a namespace:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell",metastring:"script",children:"cat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: spark-test\nEOF\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Create service account and cluster role bindings under ",(0,r.jsx)(s.code,{children:"spark-test"})," namespace:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell",metastring:"script",children:'cat <<EOF | kubectl apply -n spark-test -f -\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: spark\n  namespace: spark-test\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: spark-cluster-role\n  namespace: spark-test\nrules:\n- apiGroups: [""]\n  resources: ["pods"]\n  verbs: ["get", "watch", "list", "create", "delete"]\n- apiGroups: [""]\n  resources: ["configmaps"]\n  verbs: ["get", "create", "delete"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: spark-cluster-role-binding\n  namespace: spark-test\nsubjects:\n- kind: ServiceAccount\n  name: spark\n  namespace: spark-test\nroleRef:\n  kind: ClusterRole\n  name: spark-cluster-role\n  apiGroup: rbac.authorization.k8s.io\nEOF\n'})}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["Do NOT use ",(0,r.jsx)(s.code,{children:"ClusterRole"})," and ",(0,r.jsx)(s.code,{children:"ClusterRoleBinding"})," to run Spark jobs in production, please configure a more fine-grained\nsecurity context for running Spark jobs. See more about how to configure proper RBAC rules ",(0,r.jsx)(s.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/rbac/",children:"here"}),"."]})}),"\n",(0,r.jsx)(s.h2,{id:"submit-a-spark-job",children:"Submit a Spark job"}),"\n",(0,r.jsx)(s.p,{children:"If this is running from local machine, you will need to start the proxy in order to talk to the api-server."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell",metastring:"script",children:"kubectl proxy\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Run a simple SparkPi job (this assumes that the Spark binaries are installed to ",(0,r.jsx)(s.code,{children:"/usr/local"})," directory)."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell",metastring:"script",children:"export SPARK_HOME=/usr/local/spark-2.4.4-bin-hadoop2.7/\n${SPARK_HOME}/bin/spark-submit --master k8s://http://localhost:8001 --deploy-mode cluster --name spark-pi \\\n   --master k8s://http://localhost:8001 --deploy-mode cluster --name spark-pi \\\n   --class org.apache.spark.examples.SparkPi \\\n   --conf spark.executor.instances=1 \\\n   --conf spark.kubernetes.namespace=spark-test \\\n   --conf spark.kubernetes.executor.request.cores=1 \\\n   --conf spark.kubernetes.container.image=apache/yunikorn:spark-2.4.4 \\\n   --conf spark.kubernetes.authenticate.driver.serviceAccountName=spark-test:spark \\\n   local:///opt/spark/examples/jars/spark-examples_2.11-2.4.4.jar\n"})}),"\n",(0,r.jsx)(s.p,{children:"You'll see Spark driver and executors been created on Kubernetes:"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"spark-pods",src:n(61020).A+"",width:"2724",height:"1288"})}),"\n",(0,r.jsxs)(s.p,{children:["You can also view the job info from YuniKorn UI. If you do not know how to access the YuniKorn UI, please read the document\n",(0,r.jsx)(s.a,{href:"/docs/0.12.2/#access-the-web-ui",children:"here"}),"."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"spark-jobs-on-ui",src:n(42737).A+"",width:"5972",height:"1732"})}),"\n",(0,r.jsx)(s.h2,{id:"what-happens-behind-the-scenes",children:"What happens behind the scenes?"}),"\n",(0,r.jsxs)(s.p,{children:["When the Spark job is submitted to the cluster, the job is submitted to ",(0,r.jsx)(s.code,{children:"spark-test"})," namespace. The Spark driver pod will\nbe firstly created under this namespace. Since this cluster has YuniKorn admission-controller enabled, when the driver pod\nget created, the admission-controller mutates the pod's spec and injects ",(0,r.jsx)(s.code,{children:"schedulerName=yunikorn"}),", by doing this, the\ndefault K8s scheduler will skip this pod and it will be scheduled by YuniKorn instead. See how this is done by ",(0,r.jsx)(s.a,{href:"https://kubernetes.io/docs/tasks/extend-kubernetes/configure-multiple-schedulers/",children:"configuring\nanother scheduler in Kubernetes"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["The default configuration has placement rule enabled, which automatically maps the ",(0,r.jsx)(s.code,{children:"spark-test"})," namespace to a YuniKorn\nqueue ",(0,r.jsx)(s.code,{children:"root.spark-test"}),". All Spark jobs submitted to this namespace will be automatically submitted to the queue first.\nTo see more about how placement rule works, please see doc ",(0,r.jsx)(s.a,{href:"/docs/0.12.2/user_guide/placement_rules",children:"placement-rules"}),". By far,\nthe namespace defines the security context of the pods, and the queue determines how the job and pods will be scheduled\nwith considering of job ordering, queue resource fairness, etc. Note, this is the simplest setup, which doesn't enforce\nthe queue capacities. The queue is considered as having unlimited capacity."]}),"\n",(0,r.jsxs)(s.p,{children:["YuniKorn reuses the Spark application ID set in label ",(0,r.jsx)(s.code,{children:"spark-app-selector"}),", and this job is submitted\nto YuniKorn and being considered as a job. The job is scheduled and running as there is sufficient resources in the cluster.\nYuniKorn allocates the driver pod to a node, binds the pod and starts all the containers. Once the driver pod gets started,\nit requests for a bunch of executor pods to run its tasks. Those pods will be created in the same namespace as well and\nscheduled by YuniKorn as well."]})]})}function p(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},42737:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/spark-jobs-on-ui-21e219c2182fd987302f26a7428b9cac.png"},61020:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/spark-pods-21a4c799796031460e737650d06d3f7b.png"},1780:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>i});var r=n(79474);const a={},t=r.createContext(a);function o(e){const s=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(t.Provider,{value:s},e.children)}}}]);